<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js 进阶 | Awesome-FE</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="个人笔记">
    
    <link rel="preload" href="/awesome/assets/css/0.styles.de4ab01b.css" as="style"><link rel="preload" href="/awesome/assets/js/app.ca8b16c8.js" as="script"><link rel="preload" href="/awesome/assets/js/2.b179fbd3.js" as="script"><link rel="preload" href="/awesome/assets/js/5.6fad60fb.js" as="script"><link rel="prefetch" href="/awesome/assets/js/10.197ac888.js"><link rel="prefetch" href="/awesome/assets/js/100.b37f94a2.js"><link rel="prefetch" href="/awesome/assets/js/11.9ebdc1ab.js"><link rel="prefetch" href="/awesome/assets/js/12.46262d3e.js"><link rel="prefetch" href="/awesome/assets/js/13.636cf6dd.js"><link rel="prefetch" href="/awesome/assets/js/14.aa044fde.js"><link rel="prefetch" href="/awesome/assets/js/15.ccb99c80.js"><link rel="prefetch" href="/awesome/assets/js/16.bfd9f989.js"><link rel="prefetch" href="/awesome/assets/js/17.c3f6e234.js"><link rel="prefetch" href="/awesome/assets/js/18.79b438cd.js"><link rel="prefetch" href="/awesome/assets/js/19.3cded07b.js"><link rel="prefetch" href="/awesome/assets/js/20.bcf87cb7.js"><link rel="prefetch" href="/awesome/assets/js/21.cd9f9eb3.js"><link rel="prefetch" href="/awesome/assets/js/22.7ef20e82.js"><link rel="prefetch" href="/awesome/assets/js/23.8c735063.js"><link rel="prefetch" href="/awesome/assets/js/24.1990aae1.js"><link rel="prefetch" href="/awesome/assets/js/25.7ed8ead0.js"><link rel="prefetch" href="/awesome/assets/js/26.04d13a8e.js"><link rel="prefetch" href="/awesome/assets/js/27.cd391275.js"><link rel="prefetch" href="/awesome/assets/js/28.c6a4df96.js"><link rel="prefetch" href="/awesome/assets/js/29.e65fe6e6.js"><link rel="prefetch" href="/awesome/assets/js/3.6e2c802a.js"><link rel="prefetch" href="/awesome/assets/js/30.2774a2bc.js"><link rel="prefetch" href="/awesome/assets/js/31.95984446.js"><link rel="prefetch" href="/awesome/assets/js/32.0355dea1.js"><link rel="prefetch" href="/awesome/assets/js/33.825a4222.js"><link rel="prefetch" href="/awesome/assets/js/34.585e4b78.js"><link rel="prefetch" href="/awesome/assets/js/35.9c8bf76d.js"><link rel="prefetch" href="/awesome/assets/js/36.8f4e0b7e.js"><link rel="prefetch" href="/awesome/assets/js/37.ff306c03.js"><link rel="prefetch" href="/awesome/assets/js/38.e35c5efc.js"><link rel="prefetch" href="/awesome/assets/js/39.e5dbc6b2.js"><link rel="prefetch" href="/awesome/assets/js/4.8ca5e96a.js"><link rel="prefetch" href="/awesome/assets/js/40.6313af40.js"><link rel="prefetch" href="/awesome/assets/js/41.ef11884c.js"><link rel="prefetch" href="/awesome/assets/js/42.6efa4f53.js"><link rel="prefetch" href="/awesome/assets/js/43.42ec729d.js"><link rel="prefetch" href="/awesome/assets/js/44.a5c0fed7.js"><link rel="prefetch" href="/awesome/assets/js/45.052639b6.js"><link rel="prefetch" href="/awesome/assets/js/46.0a1cb70c.js"><link rel="prefetch" href="/awesome/assets/js/47.4b98b32f.js"><link rel="prefetch" href="/awesome/assets/js/48.32c46a69.js"><link rel="prefetch" href="/awesome/assets/js/49.952e4e0c.js"><link rel="prefetch" href="/awesome/assets/js/50.c5c55187.js"><link rel="prefetch" href="/awesome/assets/js/51.ac363139.js"><link rel="prefetch" href="/awesome/assets/js/52.4eb06a71.js"><link rel="prefetch" href="/awesome/assets/js/53.b9c805c8.js"><link rel="prefetch" href="/awesome/assets/js/54.9b7f29ed.js"><link rel="prefetch" href="/awesome/assets/js/55.a45610af.js"><link rel="prefetch" href="/awesome/assets/js/56.dcbc31df.js"><link rel="prefetch" href="/awesome/assets/js/57.b4bd1952.js"><link rel="prefetch" href="/awesome/assets/js/58.8c83eed2.js"><link rel="prefetch" href="/awesome/assets/js/59.0975a796.js"><link rel="prefetch" href="/awesome/assets/js/6.4e514ee6.js"><link rel="prefetch" href="/awesome/assets/js/60.f5896e7a.js"><link rel="prefetch" href="/awesome/assets/js/61.f360bf98.js"><link rel="prefetch" href="/awesome/assets/js/62.2d66cc03.js"><link rel="prefetch" href="/awesome/assets/js/63.224032a3.js"><link rel="prefetch" href="/awesome/assets/js/64.c5efcb1d.js"><link rel="prefetch" href="/awesome/assets/js/65.c7c5099c.js"><link rel="prefetch" href="/awesome/assets/js/66.56099b67.js"><link rel="prefetch" href="/awesome/assets/js/67.e3f05393.js"><link rel="prefetch" href="/awesome/assets/js/68.d3f3c73a.js"><link rel="prefetch" href="/awesome/assets/js/69.71d91ecb.js"><link rel="prefetch" href="/awesome/assets/js/7.f44beaa8.js"><link rel="prefetch" href="/awesome/assets/js/70.2341f421.js"><link rel="prefetch" href="/awesome/assets/js/71.01002dfe.js"><link rel="prefetch" href="/awesome/assets/js/72.71b97166.js"><link rel="prefetch" href="/awesome/assets/js/73.4aea7f78.js"><link rel="prefetch" href="/awesome/assets/js/74.da5740e6.js"><link rel="prefetch" href="/awesome/assets/js/75.4f0abc43.js"><link rel="prefetch" href="/awesome/assets/js/76.d0845bc7.js"><link rel="prefetch" href="/awesome/assets/js/77.c9f211ea.js"><link rel="prefetch" href="/awesome/assets/js/78.97266e5d.js"><link rel="prefetch" href="/awesome/assets/js/79.15e0c11f.js"><link rel="prefetch" href="/awesome/assets/js/8.f9a38e2e.js"><link rel="prefetch" href="/awesome/assets/js/80.02016e21.js"><link rel="prefetch" href="/awesome/assets/js/81.4f0905aa.js"><link rel="prefetch" href="/awesome/assets/js/82.64b2d1ca.js"><link rel="prefetch" href="/awesome/assets/js/83.fabb9f38.js"><link rel="prefetch" href="/awesome/assets/js/84.8542bdbe.js"><link rel="prefetch" href="/awesome/assets/js/85.62623aa1.js"><link rel="prefetch" href="/awesome/assets/js/86.7aaafaba.js"><link rel="prefetch" href="/awesome/assets/js/87.d6861be8.js"><link rel="prefetch" href="/awesome/assets/js/88.39c7e1a1.js"><link rel="prefetch" href="/awesome/assets/js/89.396a9f76.js"><link rel="prefetch" href="/awesome/assets/js/9.3b0fa6be.js"><link rel="prefetch" href="/awesome/assets/js/90.38c6f5f2.js"><link rel="prefetch" href="/awesome/assets/js/91.3603e5b3.js"><link rel="prefetch" href="/awesome/assets/js/92.bcb02572.js"><link rel="prefetch" href="/awesome/assets/js/93.a4194e52.js"><link rel="prefetch" href="/awesome/assets/js/94.61bb5917.js"><link rel="prefetch" href="/awesome/assets/js/95.d7599ac6.js"><link rel="prefetch" href="/awesome/assets/js/96.ca73174c.js"><link rel="prefetch" href="/awesome/assets/js/97.6c92ea11.js"><link rel="prefetch" href="/awesome/assets/js/98.81ce7b8b.js"><link rel="prefetch" href="/awesome/assets/js/99.ad64ce95.js">
    <link rel="stylesheet" href="/awesome/assets/css/0.styles.de4ab01b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/awesome/" class="home-link router-link-active"><!----> <span class="site-name">Awesome-FE</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/awesome/fn.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/awesome/bn.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  后端
</a></div><div class="nav-item"><a href="/awesome/note.html" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="/awesome/interview.html" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="https://github.com/Composur" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/awesome/fn.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/awesome/bn.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  后端
</a></div><div class="nav-item"><a href="/awesome/note.html" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="/awesome/interview.html" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="https://github.com/Composur" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Node.js 进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/awesome/bn.html#bff-层" class="sidebar-link">BFF 层</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/awesome/bn.html#_1-node-环境的-js-和-chrome-环境的-js-运行的不同点" class="sidebar-link">1. Node 环境的 js 和 Chrome 环境的 js 运行的不同点</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_2-node-js-应用领域" class="sidebar-link">2. Node.js 应用领域</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_3-bff-层" class="sidebar-link">3. BFF 层</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_4-小游戏" class="sidebar-link">4. 小游戏</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_5-node-js-内置模块" class="sidebar-link">5. Node.js 内置模块</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_6-node-js-的异步、非阻塞-i-o" class="sidebar-link">6. Node.js 的异步、非阻塞 I/O</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_7-node-js-异步编程-callback" class="sidebar-link">7. Node.js 异步编程 -- callback</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_8-http-服务" class="sidebar-link">8. HTTP 服务</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_9-rpc通信" class="sidebar-link">9. RPC通信</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_10-api-服务" class="sidebar-link">10. API 服务</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_11-node-js-性能优化" class="sidebar-link">11. Node.js 性能优化</a></li><li class="sidebar-sub-header"><a href="/awesome/bn.html#_12-架构优化" class="sidebar-link">12. 架构优化</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="node-js-进阶"><a href="#node-js-进阶" class="header-anchor">#</a> Node.js 进阶</h1> <h2 id="bff-层"><a href="#bff-层" class="header-anchor">#</a> BFF 层</h2> <h3 id="_1-node-环境的-js-和-chrome-环境的-js-运行的不同点"><a href="#_1-node-环境的-js-和-chrome-环境的-js-运行的不同点" class="header-anchor">#</a> 1. Node 环境的 js 和 Chrome 环境的 js 运行的不同点</h3> <blockquote><p>js执行为单线程（不考虑web worker），所有代码皆在执行线程调用栈完成执行。当执行线程任务清空后才会去轮询取任务队列中任务。</p></blockquote> <ul><li>Nodejs 没有浏览器的 API，如 document、window等。</li> <li>加入了许多 NodeJS 的 API。</li> <li>Js 控制浏览器，Node.js 控制计算机。</li></ul> <h3 id="_2-node-js-应用领域"><a href="#_2-node-js-应用领域" class="header-anchor">#</a> 2. Node.js 应用领域</h3> <ul><li>web 服务
<ul><li>搜索引擎优化，首屏加速。采取服务端渲染。</li></ul></li> <li>客户端应用
<ul><li>在已有网站的情况下，需要开发新的客户端</li> <li>用 Node.js 客户端技术 （electron）实现，最大限度的复用现有的工程。</li></ul></li></ul> <h3 id="_3-bff-层"><a href="#_3-bff-层" class="header-anchor">#</a> 3. BFF 层</h3> <blockquote><p>Backend for Frontend 为前端服务的后端</p></blockquote> <p><img src="/awesome/assets/img/bff.c8a63e0e.jpg" alt="bff"></p> <ul><li>对用户侧提供 HTTP 服务</li> <li>使用后端 RPC 服务</li></ul> <h3 id="_4-小游戏"><a href="#_4-小游戏" class="header-anchor">#</a> 4. 小游戏</h3> <h4 id="_4-1-实现步骤"><a href="#_4-1-实现步骤" class="header-anchor">#</a> 4.1 实现步骤</h4> <p><a href="https://github.com/Composur/v2ex-nodejs/tree/master/CommonJS" target="_blank" rel="noopener noreferrer">石头✂️布<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>输入你要出的类型回车即可。</p> <p><img src="/awesome/assets/img/WechatIMG219.0fb006b1.jpeg" alt=""></p> <p>用到了 <code>process</code> 较多的的属性。如<code>argv</code> 、<code>stdin</code>...</p> <p>步骤：</p> <ol><li><p>取到用户的控制台输入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> userAction <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
</code></pre></div></li> <li><p>运算逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果没有导出 其它文件引入该文件默认是一个空对象</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">userAction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> log <span class="token punctuation">}</span> <span class="token operator">=</span> console
  <span class="token comment">// 计算机随机出一个</span>
  <span class="token keyword">let</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
  <span class="token keyword">let</span> computerAction<span class="token punctuation">;</span>
  <span class="token keyword">const</span> rock <span class="token operator">=</span> <span class="token string">'rock'</span><span class="token punctuation">,</span> paper <span class="token operator">=</span> <span class="token string">'paper'</span><span class="token punctuation">,</span> scissor <span class="token operator">=</span> <span class="token string">'scissor'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>random <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    computerAction <span class="token operator">=</span> rock
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>random <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    computerAction <span class="token operator">=</span> paper
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    computerAction <span class="token operator">=</span> scissor
  <span class="token punctuation">}</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">你出了</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userAction<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">；计算机出了</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>computerAction<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>userAction <span class="token operator">===</span> computerAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'平局！！'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>userAction <span class="token operator">===</span> rock <span class="token operator">&amp;&amp;</span> computerAction <span class="token operator">==</span> scissor<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span>userAction <span class="token operator">===</span> paper <span class="token operator">&amp;&amp;</span> computerAction <span class="token operator">==</span> rock<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span>userAction <span class="token operator">===</span> scissor <span class="token operator">&amp;&amp;</span> computerAction <span class="token operator">==</span> paper<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'你赢了！！'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'你输了！！'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>监听输入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> playAction<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/common'</span><span class="token punctuation">)</span> 
<span class="token keyword">let</span> result<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 让程序不中断，一直执行</span>
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> userInputValue<span class="token operator">=</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  result<span class="token operator">=</span> <span class="token function">playAction</span><span class="token punctuation">(</span>userInputValue<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    result<span class="token operator">++</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">===</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'你太厉害了！！'</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ol> <h4 id="_4-2-commjs-规范"><a href="#_4-2-commjs-规范" class="header-anchor">#</a> 4.2 CommJS 规范</h4> <h5 id="_4-2-1-没有规范出现的问题"><a href="#_4-2-1-没有规范出现的问题" class="header-anchor">#</a> 4.2.1 没有规范出现的问题</h5> <ol><li>没有 <code>&lt;script&gt;&lt;/script&gt;</code>就写不了 js 代码</li> <li>脚本变多的时候需要手动加载管理</li> <li>不同脚本间的调用，需要通过全局变量的方式。</li></ol> <h5 id="_4-2-2-require"><a href="#_4-2-2-require" class="header-anchor">#</a> 4.2.2 Require()</h5> <p>如何引入一个 js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a.js'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">'a'</span>

<span class="token comment">// b.js</span>
<span class="token keyword">const</span> lib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'a.js'</span><span class="token punctuation">)</span>
<span class="token comment">// 如果没有 export.xx 进行导出的话 require 引入的默认是一个空对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>lib<span class="token punctuation">)</span> <span class="token comment">// {a:'a'}</span>
</code></pre></div><p>问题：b.js 中 lib 的引用和 a.js 是否是同一个引用 ？<strong>答案：是统一引用</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是a.js'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token comment">//  1 秒后打印 { addNewProperty: '我是b.js中新增加的属性' }</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>


<span class="token comment">// b.js</span>
<span class="token keyword">const</span> lib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是b.js'</span><span class="token punctuation">,</span>lib<span class="token punctuation">)</span> <span class="token comment">// 我是b.js {}</span>
lib<span class="token punctuation">.</span>addNewProperty <span class="token operator">=</span> <span class="token string">'我是b.js中新增加的属性'</span>
</code></pre></div><h5 id="_4-2-3-module-exports-vs-exports"><a href="#_4-2-3-module-exports-vs-exports" class="header-anchor">#</a> 4.2.3 module.exports vs exports</h5> <p><code>module.exports</code> 会把所有 <code>exports</code> 导出覆盖掉。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
exports<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token string">'我是a.js'</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token comment">// { hello: '我是a.js' }</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是a.js导出的function'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// b.js</span>
<span class="token keyword">const</span> lib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是b.js'</span><span class="token punctuation">,</span>lib<span class="token punctuation">)</span> <span class="token comment">// 我是b.js [Function: test]</span>
lib<span class="token punctuation">.</span>addNewProperty <span class="token operator">=</span> <span class="token string">'我是b.js中新增加的属性'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>lib<span class="token punctuation">.</span>hello<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
</code></pre></div><h5 id="_4-2-4-webpack-中的-commonjs"><a href="#_4-2-4-webpack-中的-commonjs" class="header-anchor">#</a> 4.2.4 Webpack 中的 CommonJS</h5> <p>Webpack 会把所有的 .js 文件分析一遍，然后打包成一个大的 main.js 文件。在这个 main.js 中每个所有的 .js 文件以一个函数的形成存在。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//a.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a.js'</span><span class="token punctuation">)</span>

<span class="token comment">//b.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b.js'</span><span class="token punctuation">)</span>
</code></pre></div><p>webpack 打包后：</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/***/</span> <span class="token string">&quot;./a.js&quot;</span><span class="token operator">:</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;console.log('a.js')\n\n//# sourceURL=webpack:///./a.js?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   
<span class="token comment">/***/</span> <span class="token string">&quot;./b.js&quot;</span><span class="token operator">:</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;console.log('b.js')\n\n//# sourceURL=webpack:///./b.js?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  
<span class="token comment">/***/</span> <span class="token string">&quot;./index.js&quot;</span><span class="token operator">:</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;__webpack_require__(/*! ./a */ \&quot;./a.js\&quot;)\n__webpack_require__(/*! ./b */ \&quot;./b.js\&quot;)\nconsole.log('index.js')\n\n//#sourceURL=webpack:///./index.js?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>会有一个函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 传入一个 id  入口</span>
<span class="token comment">/******/</span> 	<span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">/******/</span>		<span class="token comment">// 是否有缓存</span>
<span class="token comment">/******/</span> 		<span class="token comment">// Check if module is in cache</span>
<span class="token comment">/******/</span> 		<span class="token keyword">if</span><span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  					<span class="token comment">// 返回上一次的结果</span>
<span class="token comment">/******/</span> 			<span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token comment">/******/</span> 		<span class="token punctuation">}</span>
  					<span class="token comment">// 如果没有命中缓存</span>
<span class="token comment">/******/</span> 		<span class="token comment">// Create a new module (and put it into the cache)</span>
<span class="token comment">/******/</span> 		<span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token comment">/******/</span> 			i<span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
<span class="token comment">/******/</span> 			l<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token comment">/******/</span> 			exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">/******/</span> 		<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/******/</span>
<span class="token comment">/******/</span> 		<span class="token comment">// Execute the module function</span>
  					<span class="token comment">// 调用模块</span>
<span class="token comment">/******/</span> 		modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/******/</span>
<span class="token comment">/******/</span> 		<span class="token comment">// Flag the module as loaded</span>
<span class="token comment">/******/</span> 		module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment">/******/</span>
<span class="token comment">/******/</span> 		<span class="token comment">// Return the exports of the module</span>
<span class="token comment">/******/</span> 		<span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token comment">/******/</span> 	<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-node-js-内置模块"><a href="#_5-node-js-内置模块" class="header-anchor">#</a> 5. Node.js 内置模块</h3> <p><img src="/awesome/assets/img/nodejs.6db4c5ea.jpg" alt="nodejs"></p> <p>根据上图所示，由 JavaScript 到 V8 再到 Node.js 的能力大部分是由内置模块提供的，所以我们必须要了解一些核心 <code>fs</code> <code>os</code> <code>net</code> <code>Process</code> ... 等模块。</p> <h4 id="_5-1-js-和-node-js-的交互"><a href="#_5-1-js-和-node-js-的交互" class="header-anchor">#</a> 5.1 js 和 node.js 的交互</h4> <p>例如我们想通过 js 获取计算机的 <code>cpu</code> 信息：</p> <ol><li>打开 node 的 <a href="https://github.com/nodejs/node/blob/master/lib/os.js" target="_blank" rel="noopener noreferrer">os.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 模块（在 lib 文件夹里面）。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>
  getCPUs<span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">internalBinding</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// internalBinding 是 V8 的方法 </span>

<span class="token keyword">function</span> <span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过引入的 os 得到 getCPUs() </span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">getCPUs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      model<span class="token operator">:</span> data<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      speed<span class="token operator">:</span> data<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      times<span class="token operator">:</span> <span class="token punctuation">{</span>
        user<span class="token operator">:</span> data<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        nice<span class="token operator">:</span> data<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        sys<span class="token operator">:</span> data<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        idle<span class="token operator">:</span> data<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        irq<span class="token operator">:</span> data<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  cpus<span class="token punctuation">,</span> <span class="token comment">// 一个方法</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>C++ 提供的方法</li></ol> <p><a href="https://github.com/nodejs/node/blob/master/src/node_os.cc" target="_blank" rel="noopener noreferrer">node_os.cc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node_os.cc</span>
<span class="token comment">//  v8 转化 js</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">GetCPUInfo</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Environment<span class="token operator">*</span> env <span class="token operator">=</span> Environment<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetCurrent</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  uv_cpu_info_t<span class="token operator">*</span> cpu_infos<span class="token punctuation">;</span>
  int count<span class="token punctuation">;</span>

  int err <span class="token operator">=</span> <span class="token function">uv_cpu_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_infos<span class="token punctuation">,</span> <span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  
  std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;&gt;</span> <span class="token function">result</span><span class="token punctuation">(</span>count <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uv_cpu_info_t<span class="token operator">*</span> ci <span class="token operator">=</span> cpu_infos <span class="token operator">+</span> i<span class="token punctuation">;</span>
    result<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">OneByteString</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> ci<span class="token operator">-</span><span class="token operator">&gt;</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> Number<span class="token operator">:</span><span class="token operator">:</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> ci<span class="token operator">-</span><span class="token operator">&gt;</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> Number<span class="token operator">:</span><span class="token operator">:</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> ci<span class="token operator">-</span><span class="token operator">&gt;</span>cpu_times<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> Number<span class="token operator">:</span><span class="token operator">:</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> ci<span class="token operator">-</span><span class="token operator">&gt;</span>cpu_times<span class="token punctuation">.</span>nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> Number<span class="token operator">:</span><span class="token operator">:</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> ci<span class="token operator">-</span><span class="token operator">&gt;</span>cpu_times<span class="token punctuation">.</span>sys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> Number<span class="token operator">:</span><span class="token operator">:</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> ci<span class="token operator">-</span><span class="token operator">&gt;</span>cpu_times<span class="token punctuation">.</span>idle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> Number<span class="token operator">:</span><span class="token operator">:</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> ci<span class="token operator">-</span><span class="token operator">&gt;</span>cpu_times<span class="token punctuation">.</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	
  <span class="token comment">// C++ 的方法去获取 cpu 信息</span>
  <span class="token function">uv_free_cpu_info</span><span class="token punctuation">(</span>cpu_infos<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 转成 js 能用的</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>Array<span class="token operator">:</span><span class="token operator">:</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token parameter">Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> target<span class="token punctuation">,</span>
                Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> unused<span class="token punctuation">,</span>
                Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context<span class="token punctuation">,</span>
                <span class="token keyword">void</span><span class="token operator">*</span> priv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Environment<span class="token operator">*</span> env <span class="token operator">=</span> Environment<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetCurrent</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 这里提供了 GetCPUInfo 方法</span>
  env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetMethod</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;getCPUs&quot;</span><span class="token punctuation">,</span> GetCPUInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
  target<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Set</span><span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token constant">FIXED_ONE_BYTE_STRING</span><span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;isBigEndian&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              Boolean<span class="token operator">:</span><span class="token operator">:</span><span class="token function">New</span><span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">IsBigEndian</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-2-实现一个事件收发器"><a href="#_5-2-实现一个事件收发器" class="header-anchor">#</a> 5.2 实现一个事件收发器</h4> <p>操作系统底层通过 node.js 到 js 的过程，用我们上面的小游戏举例（node环境）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取控制台的输入</span>
<span class="token comment">// 这里用到了 EventEmitter 模块</span>
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> userInputValue<span class="token operator">=</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>EventEmitter</code> 可以从 node 层抛出一些数据给 js</p> <p><strong>观察者模式</strong>举例：</p> <blockquote><p>观察者（Observer）模式的定义：指多个对象间存在一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。这种模式有时又称作发布-订阅模式、模型-视图模式，它是对象行为型模式。</p></blockquote> <p>后端每隔 2 秒通知一次前端：</p> <p><em>observer(观察者)</em></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>EventEmitter
<span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 发射事件，给外面的业务代码抛出一些东西出去</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'listen'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>date<span class="token operator">:</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>test<span class="token operator">:</span><span class="token string">'2秒触发一次'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span>Test
</code></pre></div><p><em>subscribe(订阅者)</em></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/EventEmitter'</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> test01 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span> 

<span class="token comment">// 接收事件</span>
test01<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'listen'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 这里可以进行业务逻辑处理</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// {</span>
<span class="token comment">//   date: 'Sat Mar 07 2020 21:10:50 GMT+0800 (GMT+08:00)',</span>
<span class="token comment">//   test: '2秒触发一次'</span>
<span class="token comment">// }</span>
<span class="token comment">// {</span>
<span class="token comment">//   date: 'Sat Mar 07 2020 21:10:52 GMT+0800 (GMT+08:00)',</span>
<span class="token comment">//   test: '2秒触发一次'</span>
<span class="token comment">// }</span>
<span class="token comment">// {</span>
<span class="token comment">//   date: 'Sat Mar 07 2020 21:10:54 GMT+0800 (GMT+08:00)',</span>
<span class="token comment">//   test: '2秒触发一次'</span>
<span class="token comment">// }</span>
</code></pre></div><p>这样我们就实现了一个简单的事件收发器。这样做的缺点是：</p> <ol><li>不知道被通知者是否存在。被通知者也不知道通知者是否存在。</li> <li>不知道被通知者是谁，谁都可以被通知到，广播的性质。</li></ol> <h4 id="_5-3-buffer-缓冲器"><a href="#_5-3-buffer-缓冲器" class="header-anchor">#</a> 5.3 Buffer (缓冲器)</h4> <blockquote><p><code>Buffer</code> 类是作为 Node.js API 的一部分引入的，用于在 TCP 流、文件系统操作、以及其他上下文中与八位字节流进行交互。</p></blockquote> <h4 id="_5-4-net-网络"><a href="#_5-4-net-网络" class="header-anchor">#</a> 5.4 NET (网络)</h4> <blockquote><p><code>net</code> 模块用于创建基于流的 TCP 或 <a href="http://nodejs.cn/s/rAdYjf" target="_blank" rel="noopener noreferrer">IPC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的服务器（<a href="http://nodejs.cn/s/e8cikS" target="_blank" rel="noopener noreferrer"><code>net.createServer()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）与客户端（<a href="http://nodejs.cn/s/RTNxdX" target="_blank" rel="noopener noreferrer"><code>net.createConnection()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></blockquote> <ul><li><p>服务端</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token parameter">data</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// get client send data </span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 30 31&gt; 01</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>客户端</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>
<span class="token comment">// Socket 网络中写入和取出的代理对象</span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">net<span class="token punctuation">.</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 

socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token operator">:</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span><span class="token number">12345</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'establish on 12345'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//单工模式 只能客户端向浏览器端发送数据</span>
socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'01'</span><span class="token punctuation">)</span> 
</code></pre></div></li></ul> <h4 id="_5-5-cluster-集群"><a href="#_5-5-cluster-集群" class="header-anchor">#</a> 5.5 Cluster (集群)</h4> <p>作用：分发 <code>HTTP</code> 请求。</p> <p><code>Node.js</code> 对浏览器提供服务，浏览器请求 <code>Node.js</code>，请求到了 master（主进程），假如 <code>fork</code> 4 个子进程（ <code>CPU</code>4 核心），每个子进程都运行一个 <code>HTTP</code> 服务，收到 <code>HTTP</code> 请求后并处理完成后返回给主进程，主进程再返回浏览器。</p> <p>上面的逻辑可以借助 <code>cluster</code> 这个模块进行处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 添加启动脚本 app.js 进行多进程启动 充分利用 CPU 的多核心</span>
<span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;os&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据 CPU 的最大核心数进行启动</span>
  <span class="token comment">// 这样 会造成一定的浪费 内存空间使用率较高</span>
  <span class="token comment">// 根据实际情况开启进程，一般开启一半就可以</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpus<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这样就会有多个进程监听 3000 端口</span>
<span class="token punctuation">}</span>
</code></pre></div><p>问题：多个进程是如何无冲突的监听一个端口？<small>理论上应该报错才对</small></p> <p>其实是主线程在监听，子线程监听的是一个类似 id 的东西。</p> <h3 id="_6-node-js-的异步、非阻塞-i-o"><a href="#_6-node-js-的异步、非阻塞-i-o" class="header-anchor">#</a> 6. Node.js 的异步、非阻塞 I/O</h3> <blockquote><p>阻塞 I/O 非阻塞 I/O 的区别就是：<strong>系统在接收输入再到输出期间，还能不能再接收其它输入</strong>。</p> <p>&quot;I/O&quot; 主要指由 <a href="https://libuv.org/" target="_blank" rel="noopener noreferrer">libuv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 支持的，与系统磁盘和网络之间的交互。</p></blockquote> <p><a href="https://nodejs.org/zh-cn/docs/guides/blocking-vs-non-blocking/" target="_blank" rel="noopener noreferrer">阻塞对比非阻塞一览<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_6-1-同步-阻塞-举例"><a href="#_6-1-同步-阻塞-举例" class="header-anchor">#</a> 6.1 同步（阻塞）举例：</h4> <p>在学校食堂窗口买饭，需要到窗口排队，你必须等到排到你才能选餐。需要等待。</p> <p><small>插队什么的不在考虑范围，会被女同学骂</small>。</p> <h4 id="_6-2-异步-非阻塞-举例"><a href="#_6-2-异步-非阻塞-举例" class="header-anchor">#</a> 6.2 异步（非阻塞）举例：</h4> <p>去外面餐厅吃饭，进门就有服务员招呼你点餐，不用等待就可以选餐。</p> <p><small>餐厅生意火爆需要等几个小时的不在此考虑范围。</small></p> <h4 id="_6-3-nodejs中的阻塞与非阻塞"><a href="#_6-3-nodejs中的阻塞与非阻塞" class="header-anchor">#</a> 6.3 <a href="https://nodejs.org/zh-cn/docs/guides/blocking-vs-non-blocking/" target="_blank" rel="noopener noreferrer">nodejs中的阻塞与非阻塞<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <ul><li>照搬链接中的同步举例：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 文件的读取会耗时，这里会发生阻塞</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/file.md'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 因为代码会同步执行，所以必须等到打印出 data 后，才能进行其他任务的处理</span>
<span class="token function">moreWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><ul><li>异步非阻塞：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 这里是非阻塞的</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'/file.md'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">moreWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 不必等到文件读取结束就可以执行此方法，此方法的执行不受文件读取的影响。</span>
</code></pre></div><p>这个例子就是 nodejs 的核心：<strong>异步非阻塞 I/O</strong>。用等待时间，去做其它的事情，充分利用 CPU 。</p> <p>**<code>nodejs</code> 通过一个 <a href="https://libuv.org/" target="_blank" rel="noopener noreferrer">libuv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 实现了异步非阻塞 I/O , 上面的操作（点餐）都是在一个线程里面进行，通过  <a href="https://libuv.org/" target="_blank" rel="noopener noreferrer">libuv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> **</p> <p><strong>把大量的计算分发给 <code>C++</code> 的众多模块去做，等到计算完成再把结果返回给 <code>nodejs</code> 线程，然</strong></p> <p><strong>后<code>nodejs</code> 再把结果返回给应用程序。</strong></p> <p>以去餐厅点餐为例：<strong><code>JavaScript + v8 + nodejs + libuv</code> 就是服务员，<code>libuv + C++</code> 模块就是后厨</strong>。<small><code>libuv</code> 一半是服务员，一半是后厨。</small></p> <h4 id="_6-4-事件循环"><a href="#_6-4-事件循环" class="header-anchor">#</a> 6.4 事件循环</h4> <blockquote><p>事件循环是 Node.js 处理非阻塞 I/O 操作的机制，依托 <a href="https://libuv.org/" target="_blank" rel="noopener noreferrer">libuv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>其中的一个操作完成的时候，内核通知 Node.js 将适合的回调函数添加到 <em>轮询</em> 队列中等待时机执行。</p></blockquote> <h5 id="_6-4-1-事件轮询机制解析"><a href="#_6-4-1-事件轮询机制解析" class="header-anchor">#</a> 6.4.1 事件轮询机制解析</h5> <p>Node.js 脚本启动后，开始初始化事件轮询，调用一些异步的 API、调度定时器，或者调用 <code>process.nextTick()</code>，然后开始处理事件循环。</p> <p>下图为轮询的各阶段：一共六个阶段，每个框表示一个阶段。执行到当前阶段时，会把当前阶队列中的所有回调函数执行完毕。然后移动到下一个阶段。</p> <p><img src="/awesome/assets/img/node_event_loop.825bd951.jpg" alt="事件轮询阶段"></p> <ul><li>timer（定时器阶段）
<ul><li>轮询阶段（poll）控制何时执行定时器，当它的队列任务执行完毕（异步I/O），回到最接近定时器阀值的那个定时器，执行定时器中的回调。你设定的定时器延迟时间不一定就是真实的时间可能会超过这个时间。</li></ul></li> <li>poll （轮询阶段）
<ul><li>计算应该阻塞和轮询 I/O 的时间</li> <li>处理 <strong>轮询</strong> 队列里的事件。直到队列为空。</li> <li>轮询为空，将检查已经达到阀值的定时器，然后回到 timer 阶段执行定时器的回调。</li></ul></li> <li>check （检查阶段）
<ul><li>允许 <code>setImmediate()</code> 在当前阶段完成就执行回调。（需轮询队列为空，且使用 <code>setImmediate()</code>）</li> <li><code>setImmediate()</code> 利用 <code>libuv</code> API 让回调在 <strong>轮询</strong> 阶段完成后执行。</li></ul></li></ul> <h5 id="_6-4-2-setimmediate-vs-settimeout"><a href="#_6-4-2-setimmediate-vs-settimeout" class="header-anchor">#</a> 6.4.2 <code>setImmediate()</code> vs <code>setTimeout()</code></h5> <ul><li><p><code>setImmediate()</code> 和 <code>setTimeout()</code> 类似，不同的地方上面说了，<code>setTimeout()</code> 回调是基于设置的毫秒值来执行，<code>setImmediate()</code> 是在当前 <strong>轮询</strong> 阶段完成， 就执行回调。</p></li> <li><p>不同情况下调用顺序会不一致</p> <ul><li><p>不在同一个 I/O ，打印顺序受进程性能的约束，指不定是谁。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>同一个 I/O 循环内调用，<code>setImmediate</code> 总是被优先调用。因为它在轮询结束就执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul></li></ul> <h5 id="_6-4-3-process-nexttick"><a href="#_6-4-3-process-nexttick" class="header-anchor">#</a> 6.4.3 <code>process.nextTick()</code></h5> <blockquote><p>它是一个异步 API，在当前操作完成后处理，而不管是在哪个阶段。不受阶段的影响。</p></blockquote> <p>目的是为了让我们可以在当前操作完成后立即调用我们需要执行的脚步。</p> <p>例如注册一个事件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">MyEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">EventEmitter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//  完成注册立即调用</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
util<span class="token punctuation">.</span><span class="token function">inherits</span><span class="token punctuation">(</span>MyEmitter<span class="token punctuation">,</span> EventEmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'an event occurred!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_6-4-4-事件轮询机制举例"><a href="#_6-4-4-事件轮询机制举例" class="header-anchor">#</a> 6.4.4 事件轮询机制举例</h5> <p>例如去餐厅吃饭：每次点餐都是一个新的线程（你对服务员说，服务员再通知后厨做）</p> <p>例如：</p> <ul><li>点一份生蚝炒蛋，开启线程一。</li> <li>点一份蒜蓉西蓝花，开启线程二。</li></ul> <p>**模拟 eventloop ** 极简版</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用队列 模拟调用栈</span>
<span class="token keyword">const</span> eventLoop <span class="token operator">=</span> <span class="token punctuation">{</span>
  queue<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环检测队列</span>
    <span class="token comment">//每一次事件循环都是一次全新的调用栈，从这里开始才是js代码，之前都是c++</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//这里就是nodejs调用栈的底部</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 每隔 50ms 检测一次，这是模拟的情况，实际会更快。</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 添加函数</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

eventLoop<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">// 下面的代码可以理解为是 C++ 代码的处理过程</span>

<span class="token comment">// 这是生蚝炒蛋的处理</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  eventLoop<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>

<span class="token comment">// 这是蒜蓉西蓝花的处理</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  eventLoop<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="_6-5-浏览器和-node-js-的事件循环机制有什么区别"><a href="#_6-5-浏览器和-node-js-的事件循环机制有什么区别" class="header-anchor">#</a> 6.5 浏览器和 Node.js 的事件循环机制有什么区别？</h4> <p><strong>在 node 11 版本中，node 下 Event Loop 已经与浏览器趋于相同。</strong></p> <ul><li><p>规范出处不同</p> <ul><li>浏览器的<a href="https://www.w3.org/TR/html5/webappapis.html#event-loops" target="_blank" rel="noopener noreferrer">Event loop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是在HTML5中定义的规范</li> <li>Node.js 中则由<a href="http://thlorenz.com/learnuv/book/history/history_1.html" target="_blank" rel="noopener noreferrer">libuv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>库实现</li></ul></li> <li><p>浏览器的事件循环</p> <p><small>微任务（<code>microtask</code>）Object.observe、MutationObserver、process.nextTick ，Promise.then/catch。</small></p> <p><small>宏任务（<code>macroTask</code>） script 中代码、setTimeout、setInterval、setImmediate、I/O、UI render</small></p> <ul><li>在浏览器页面中可以认为初始执行的线程中没有代码，每一个 <code>script</code> 标签中的代码是一个独立的 <code>task</code>，即会执行完前面的 <code>script</code> 中创建的 <code>microtask</code> 再执行后面的 <code>script</code> 中的同步代码。</li> <li>如果<code>microtask</code> 一直被添加，则会继续执行 <code>microtask</code> ，“卡死” <code>macrotask</code>。</li></ul></li> <li><p>Node.js 事件循环 6 个阶段</p> <ol><li>timers：执行满足条件的<code>setTimeout</code>、<code>setInterval</code> 回调。</li> <li>I/O callbacks：是否有已完成的I/O操作的回调函数，来自上一轮的 <code>poll</code> 残留。</li> <li>idle，prepare：可忽略</li> <li>poll：等待还没完成的I/O事件，会因 <code>timers</code> 和超时时间等结束等待 。</li> <li>check：执行 <code>setImmediate</code> 的回调。</li> <li>close callbacks：关闭所有的  closing handles，一些 <code>onclose</code> 事件。</li></ol></li></ul> <h3 id="_7-node-js-异步编程-callback"><a href="#_7-node-js-异步编程-callback" class="header-anchor">#</a> 7. Node.js 异步编程 -- callback</h3> <h4 id="_7-1-callback-规范"><a href="#_7-1-callback-规范" class="header-anchor">#</a> 7.1 callback 规范</h4> <ul><li>error-first callback</li> <li>Node-style callback</li></ul> <p><strong>第一个参数是 <code>error</code> 后面的才是结果。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>result<span class="token punctuation">)</span>
</code></pre></div><p>为什么需要这样，我们看一个例子：</p> <p>下面会抛出一个全局的 <code>error</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">interview</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>random<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// setTimeout 和包裹它的 interview 不在同一个调用栈错误会抛到全局。</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>random <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>random<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">interview</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 我们期望能够在这里捕获 error ,但是并没有。</span>
  <span class="token comment">// nodejs 抛出了一个全局的错误，并使程序中断。这是非常可怕的结果。</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 0.10791201989335986</span>
<span class="token comment">// /Users/haizhi/personal/v2ex-nodejs/async/callback.js:8</span>
<span class="token comment">//       throw new Error(&quot;error&quot;);</span>
<span class="token comment">//       ^</span>

<span class="token comment">// Error: error</span>
<span class="token comment">//     at Timeout._onTimeout (/Users/haizhi/personal/v2ex-nodejs/async/callback.js:8:13)</span>
<span class="token comment">//     at listOnTimeout (internal/timers.js:531:17)</span>
<span class="token comment">//     at processTimers (internal/timers.js:475:7)</span>
</code></pre></div><p>为什么会这样？<code>throw</code> 是在 <code>interview</code> 里面抛出的。但是并没有被 <code>catch</code> 捕获到。</p> <p>这就需要了解 Node.js 的事件循环机制，<strong>因为每一次事件循环，都是一次新的调用，<code>interview()</code> 和它里面的 <code>setTimeout</code>根本不在一个调用栈里面</strong>。而 <code>setTimeout</code> 执行完再次进入主线程调用的时候已经不是在<code>interview</code> 中执行的了，所以捕获不到。</p> <p>那么如何解决这类问题？</p> <p>既然有这样的错误我们就采用另一种写法：<code>callback</code> 的写法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">interview</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>random<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>random <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>random<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">interview</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 一般规定第一个参数不为空就是错误的结果</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 0.4136338806877633</span>
<span class="token comment">// error</span>
<span class="token comment">// 0.7680882379533018</span>
<span class="token comment">// success 0.7680882379533018</span>
</code></pre></div><h4 id="_7-2-promise"><a href="#_7-2-promise" class="header-anchor">#</a> 7.2 Promise</h4> <ul><li>在当期的事件循环中给不了你结果，但在未来的事件循环中会给到你结果。</li> <li>简单来说 Promise 就是一个容器，里面保存着未来才会结束的事件（通常是一个异步操作）。</li> <li>Promise 的构造函数接收一个执行函数，执行函数执行完同步或则异步操作后，调用它的两个参数 <code>resolve</code> 和 <code>rejected</code>。这两个函数分别只能只能接受一个参数。</li> <li>Promise 有三种状态<code>padding</code>（进行中）、<code>fulfilled</code>（成功）、<code>rejected</code> （失败）。</li> <li>Promise 对象的改变只有从 <code>pending</code> 变为 <code>fulfilled</code>或 <code>rejected</code>，改变后状态就凝固了，然后在<code>.then(result)</code>就会得到这个结果。</li> <li>任何一个 <code>rejected</code> 状态且后面没有 <code>catch</code> 的<code>Promise</code>，都会造成浏览器或 <code>node</code> 环境的全局错误。</li></ul> <h5 id="_7-2-1-模拟一个-promise"><a href="#_7-2-1-模拟一个-promise" class="header-anchor">#</a> 7.2.1 模拟一个  Promise</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Promise_</span><span class="token punctuation">(</span><span class="token parameter">construstor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pending <span class="token operator">=</span> <span class="token string">'pending'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> pending<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status <span class="token operator">===</span> pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&quot;resolved&quot;</span><span class="token punctuation">;</span>
      _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status <span class="token operator">===</span> pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span><span class="token punctuation">;</span>
      _this<span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">construstor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Promise_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onfullfiled<span class="token punctuation">,</span>onrejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;resolved&quot;</span><span class="token operator">:</span>
      <span class="token function">onfullfiled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;rejected&quot;</span><span class="token operator">:</span>
      <span class="token function">onrejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise_</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment">// Promise_ { status: 'fulfilled', value: 1, reason: undefined }</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
</code></pre></div><p>出现的意义是为了解决异步流程控制问题。</p> <h4 id="_7-3-async、await"><a href="#_7-3-async、await" class="header-anchor">#</a> 7.3 Async、await</h4> <h5 id="_7-3-1-aaync-和-promise-的关系"><a href="#_7-3-1-aaync-和-promise-的关系" class="header-anchor">#</a> 7.3.1 Aaync 和 Promise 的关系</h5> <p>看下面代码执行后的结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> promise <span class="token operator">=</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;resolved&gt;: undefined}</span>
<span class="token keyword">const</span> asyncFn<span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;resolved&gt;: undefined}</span>
</code></pre></div><p>均为：</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>resolved<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">}</span>
</code></pre></div><p>得出结论：</p> <p><strong><code>async</code> 就是一个返回 <code>Promise</code> 的函数，是 <code>Promise</code> 的语法糖</strong></p> <p><code>async</code> 根据函数内部的返回值进行 <code>resolve</code> <code>reject</code></p> <h5 id="_7-3-2-await-的作用"><a href="#_7-3-2-await-的作用" class="header-anchor">#</a> 7.3.2 await 的作用</h5> <ul><li><p><strong><code>await</code> 以同步的方式写异步</strong></p></li> <li><p><code>try-catch</code> 可以获取到 <code>await</code> 的错误</p></li> <li><p>可以暂停 <code>function</code> 的执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 暂停执行</span>
  <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://go'</span><span class="token punctuation">)</span>
  
  <span class="token function">doSomethingWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="_8-http-服务"><a href="#_8-http-服务" class="header-anchor">#</a> 8. HTTP 服务</h3> <ul><li>解析进来的 HTTP 请求报文</li> <li>返回对应的 HTTP 响应报文</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 一个简单的 http 服务</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="_8-1-osi-七层参考模型"><a href="#_8-1-osi-七层参考模型" class="header-anchor">#</a> 8.1 OSI 七层参考模型</h4> <h5 id="_8-1-1-网络的概念"><a href="#_8-1-1-网络的概念" class="header-anchor">#</a> 8.1.1 网络的概念</h5> <ul><li>路由协议转发。a 点到 b 点</li> <li>数据转发</li> <li>广域网链路支持。帧中继等。</li></ul> <h5 id="_8-1-2-为什么是七层模型"><a href="#_8-1-2-为什么是七层模型" class="header-anchor">#</a> 8.1.2 为什么是七层模型</h5> <p><img src="/awesome/assets/img/osi.6855b8a4.jpg" alt="osi"></p> <p><strong>A 到 B 如何通信？</strong></p> <p>a 点到 b 点的通信，过程较为复杂，考虑的问题较多。</p> <p>例如：在公司通知一件事情，由董事会决定，秘书处起草，集团下达到各个子公司，然后层层下达。</p> <p>结合上图， a 点到 b 点的通信就是，a应用层--a物理层--路由器--b物理层--b应用层，是一个 U 字形的传输过程。</p> <p><img src="/awesome/assets/img/data_trans.c91ab0ea.jpg" alt="数据传递"></p> <h5 id="_8-2-3各个层对应的体系解构"><a href="#_8-2-3各个层对应的体系解构" class="header-anchor">#</a> 8.2.3各个层对应的体系解构</h5> <ul><li>应用层
<ul><li>为应用软件提供接口，使应用程序能够使用网络服务。</li> <li>常见的应用层协议：http(80)、ftp(20/21)、telnet(23)、dns(53)、smtp(25)、pop3(110)</li></ul></li> <li>表示层
<ul><li>对应用层的数据编码、解码，加解密，压缩解压缩。</li></ul></li> <li>会话层</li> <li>对话控制、同步。</li></ul> <p><strong>上面的三层一般定义为一个应用的上层结构</strong></p> <ul><li>传输层 （TCP）
<ul><li>端到端之间的连接，对数据分段，流量控制。</li></ul></li> <li>网络层 （IP）
<ul><li>将分组数据从一个端传到另一个端。</li> <li>路由选择（IP 寻址），分组转发。</li> <li>路由器（具有后三层的功能）工作在这一层</li> <li>广播（广播域--网段）、单播（点对点）、组播（人为控制数据流向）的控制。</li> <li>连接广域网</li> <li>IP 地址
<ul><li>192.168.1.1 前三位网络号，后一位主机号。</li></ul></li></ul></li> <li>数据链路层
<ul><li>数据成帧（数据头（mac地址）+数据）送到下一层</li> <li>Mac 地址（硬件地址，烧录在网卡上面）
<ul><li>为局域网寻址定义。</li></ul></li> <li>交换机工作在这一层。</li></ul></li> <li>物理层
<ul><li>01010 正负电压，定义比特（单工、半双工、全双工 、正玄波、余弦波）进行通信。</li> <li>定义网络拓扑（星型、总线、网状、环形）等。</li></ul></li></ul> <h5 id="_8-2-4-层与层之间的关系"><a href="#_8-2-4-层与层之间的关系" class="header-anchor">#</a> 8.2.4 层与层之间的关系</h5> <p>数据是经过层层封装的</p> <p><img src="/awesome/assets/img/data_encap.18f6f51b.jpg" alt="数据封装"></p> <p><img src="/awesome/assets/img/data_unencap.f0e3e4e4.jpg" alt="解封装"></p> <ul><li>每层都有自己的功能集成。</li> <li>层与层之间相互独立又相互依靠。</li> <li>上层依赖于下层，下层为上层提供服务。</li></ul> <h4 id="_8-2-tcp-ip"><a href="#_8-2-tcp-ip" class="header-anchor">#</a> 8.2 TCP/IP</h4> <p><strong>主机到主机层</strong></p> <p><img src="/awesome/assets/img/tcpip.18ff6423.jpg" alt="tcp/ip"></p> <ul><li><p>TCP（传输控制协议） 面向连接的网络协议，一种可靠的服务。例如：电话。</p></li> <li><p>UDP （用户报文协议）无连接的网络协议。尽力而为的服务。例如：对讲机。</p></li></ul> <p><img src="/awesome/assets/img/tcp_udp.7f30ab62.jpg" alt="tcp/udp"></p> <ul><li><p>端口号 <small>用来区分不同的应用程序，软件的独立接口</small></p> <ul><li><p>源端口随机分配，目标端口（服务端应用服务的进程）使用知名端口（22，23，80，443）</p></li> <li><p>应用客户端使用的源端口号一般为系统中未使用且大于 1023 。</p></li> <li><p>我们一般起一个服务可选择的端口号为 1024—65535。</p></li></ul></li></ul> <h5 id="_8-2-1-三次握手"><a href="#_8-2-1-三次握手" class="header-anchor">#</a> 8.2.1 三次握手</h5> <p><strong>保障二者间的通信是一个可靠的连接</strong></p> <p><img src="/awesome/assets/img/establish.86c17790.jpg" alt="三次握手"></p> <ol><li>首先发送一个 SYN 报文， 打招呼的过程。</li> <li>收到一个 序列号 seq 和带有 ack 的确认报文。</li> <li>再发送一个带有序列号,和确认号的报文告诉对方确认收到你发来的信息 。然后请求对方下一个报文。</li></ol> <h5 id="_8-2-2-vlsm"><a href="#_8-2-2-vlsm" class="header-anchor">#</a> 8.2.2 VLSM</h5> <ul><li><strong>IP 地址分类</strong></li></ul> <p><img src="/awesome/assets/img/ip_class.991d0e63.jpg" alt="ip分类"></p> <p>​		D 类是组播</p> <p>​		E 类是用于科学研究</p> <ul><li><strong>网络部分和主机部分</strong></li></ul> <p><img src="/awesome/assets/img/network.e337cfd1.jpg" alt=" "></p> <p>​	黄色的部分是网络号，蓝色的是主机号 。<small>主机号的最后一位（255）是不能用作主机号的，它是广播号，发广播用</small></p> <p>​	A B C 类所包含的主机数量依次递减。A 类主机号最为庞大。</p> <ul><li><p>IP 划分</p> <p><strong>私有地址（内网IP）</strong></p></li></ul> <p><img src="/awesome/assets/img/in_ip.54292501.jpg" alt="内网IP"></p> <p>​	<strong>公网IP</strong></p> <p>​	其余的都是公网IP（不严谨，但是可以这么理解）</p> <h4 id="_8-3-koa"><a href="#_8-3-koa" class="header-anchor">#</a> 8.3 koa</h4> <p>微内核，不挂载任何中间件。为了弥补 Express 的不足而诞生。</p> <h5 id="_8-3-1-中间件"><a href="#_8-3-1-中间件" class="header-anchor">#</a> 8.3.1 中间件</h5> <p>在 Express 的中间件中，异步调用会开启另一个线程，返回的结果同一个中间件中的其它函数无法得到。但是 koa 可以 利用了 async、await</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 得到程序执行完的时间</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//  等待中间件的执行</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_8-2-2-context-request-and-response"><a href="#_8-2-2-context-request-and-response" class="header-anchor">#</a> 8.2.2 Context, Request and Response</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Request and Response 都挂到 ctx 上。ctx.request,ctx.response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'xml'</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'really_large.xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>请求和返回的处理更加明显,直接赋值。</li></ul> <h3 id="_9-rpc通信"><a href="#_9-rpc通信" class="header-anchor">#</a> 9. RPC通信</h3> <ul><li>Remote Procedure Call （远程调用）</li> <li>按 ajax  来说相同点
<ul><li>都是两个计算机之间的网络通信</li> <li>都需要双方约定一个数据格式</li></ul></li> <li>按 ajax  来说不同点
<ul><li>不一定使用 DNS 作为寻址服务（因为它是内网通信，会使用(id)唯一标识符进行寻址）</li> <li>应用层协议不使用 HTTP （使用二进制协议）</li> <li>基于 TCP 或者 UDP 协议</li></ul></li> <li>TCP 通信
<ul><li>单工通信（例如 客户端发给服务端包，只能单向通信）</li> <li>半双工通信，客户端发包期间服务端不能给客户端发包，同一时间段只允许一方发送数据。</li> <li>全双工通信</li></ul></li> <li>二进制协议
<ul><li>更小的数据包体积</li> <li>更快的编码速率（更利于计算机理解）</li></ul></li></ul> <h3 id="_10-api-服务"><a href="#_10-api-服务" class="header-anchor">#</a> 10. API 服务</h3> <h4 id="_10-1-restful"><a href="#_10-1-restful" class="header-anchor">#</a> 10.1 Restful</h4> <ul><li><p>简单易懂 （get 、post、pull、delete）,根据 methods 知意</p> <div class="language-json extra-class"><pre class="language-json"><code>http<span class="token operator">:</span><span class="token comment">//127.0.0.1/user/1 GET 请求用户信息 </span>

http<span class="token operator">:</span><span class="token comment">//127.0.0.1/user/  POST 新增用户信息 </span>

http<span class="token operator">:</span><span class="token comment">//127.0.0.1/user/1 PUT 修改用户信息 </span>

http<span class="token operator">:</span><span class="token comment">//127.0.0.1/user/1 DELETE 删除用户信息 </span>
</code></pre></div><ul><li>url风格，路由（HTTP请求函数）风格</li> <li>根据URL知道这个路由是干嘛的</li></ul></li> <li><p>便于快捷搭建</p></li> <li><p>缺点</p> <ul><li>在数据聚合方面有很大劣势，会返回许多不需要的数据</li></ul></li> <li><p>解决方案</p> <ul><li>GraphQL</li></ul></li></ul> <h4 id="_10-2-graphql"><a href="#_10-2-graphql" class="header-anchor">#</a> 10.2 GraphQL</h4> <p>专注于数据聚合，前端要什么就返回什么，不会冗余。</p> <ul><li>让前端有自定义查询数据的能力</li></ul> <h3 id="_11-node-js-性能优化"><a href="#_11-node-js-性能优化" class="header-anchor">#</a> 11. Node.js 性能优化</h3> <h4 id="_11-1-http-服务性能测试"><a href="#_11-1-http-服务性能测试" class="header-anchor">#</a> 11.1 HTTP 服务性能测试</h4> <p>想要优化性能，需要进行性能测试。</p> <ul><li>压力测试
<ul><li>ab （ApacheBench）
<ul><li>qps</li> <li>吞吐量</li></ul></li> <li>wbbench</li></ul></li> <li>性能瓶颈
<ul><li>top  （cpu、内存方面）</li> <li>iostat （硬盘 I/O）</li></ul></li></ul> <h4 id="_11-2-node-js-性能测试工具"><a href="#_11-2-node-js-性能测试工具" class="header-anchor">#</a> 11.2 Node.js 性能测试工具</h4> <ul><li><p>profile ( node 自带，性能分析那个模块占用资源多)</p> <div class="language-js extra-class"><pre class="language-js"><code>node <span class="token operator">--</span>prof index<span class="token punctuation">.</span>js <span class="token comment">// 然后进行请求得到一个文件 打开进行分析 xx &gt; profile.txt</span>
</code></pre></div></li> <li><p>Chrome devtool  (调试居多，使用 profile 面板进行分析)</p> <div class="language-js extra-class"><pre class="language-js"><code>node <span class="token operator">--</span>inspect index<span class="token punctuation">.</span>js
</code></pre></div></li> <li><p>clinic (诊所)</p> <ul><li>图表的形式</li> <li>npm 包 使用方便</li></ul></li></ul> <h4 id="_11-3-javascript-性能优化"><a href="#_11-3-javascript-性能优化" class="header-anchor">#</a> 11.3 JavaScript 性能优化</h4> <p><strong>js 是单线程的 下面优化都是基于一个线程中的优化</strong></p> <p>压测得知 buffer 操作耗费资源较多。定位代码如下 <code>readFileSync</code></p> <p><img src="/awesome/assets/img/pref_fs.ec01adae.jpg" alt="性能优化 fs"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 下载页面</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body  <span class="token operator">=</span>   fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./source/index.htm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>优化后qps 翻番：<small>提升的空间还是很大的</small></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 下载页面</span>
<span class="token keyword">const</span> str <span class="token operator">=</span>  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./source/index.htm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 移除中间价每次访问的计算</span>
    ctx<span class="token punctuation">.</span>body  <span class="token operator">=</span>  str
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/awesome/assets/img/pref_utf-8.a9dca299.jpg" alt="优化 utf-8"></p> <p>优化后我们已经看不到 耗时的 slice Function 了取而代之的是 byte-UTF-8</p> <p>以为底层是 C++ ,所以字符串，是不能直接识别的还是需要转为 buffer</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 下载页面</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
    <span class="token comment">// 不设置 type type 就是 buffer 浏览器回去执行下载的操作</span>
    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'html'</span>
    ctx<span class="token punctuation">.</span>body  <span class="token operator">=</span>   str
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>再去压测：</p> <p><img src="/awesome/assets/img/pref.f352225a.jpg" alt="性能优化"></p> <p><strong>总结：</strong></p> <ul><li>减少不必要的运算
<ul><li>精灵图，减少 HTTP 请求</li></ul></li> <li>空间换时间
<ul><li>缓存计算结果</li></ul></li> <li>提前计算
<ul><li>用的时候提前计算好，存在内存中，用的时候直接用不用再耗时计算。</li></ul></li></ul> <h4 id="_11-4-内存优化管理-垃圾回收"><a href="#_11-4-内存优化管理-垃圾回收" class="header-anchor">#</a> 11.4 内存优化管理（垃圾回收）</h4> <blockquote><p>内存泄漏：如果一个值不再需要了，引用数却不为<code>0</code>，垃圾回收机制无法释放这块内存，从而导致内存泄漏。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// arr 的引用为 1 ，垃圾回收机制无法释放这块内存</span>
arr <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 这样才会被释放掉</span>
</code></pre></div><ul><li>通过 Chrome 的 memory 面板进行内存分析（看是否有内存泄漏）</li></ul> <h4 id="_11-5-编写-c-插件"><a href="#_11-5-编写-c-插件" class="header-anchor">#</a> 11.5 编写 C++ 插件</h4> <ul><li>将计算量转移到 <code>C++</code> 进行运算
<ul><li>益处：<code>C++</code> 运算比 <code>js</code> 更快。</li> <li>成本: <code>C++</code> 和 <code>V8</code> 变量的转换。<small>js 变量和 C++ 变量的互相转换</small> <ul><li>不同的平台编译后 <code>xx.oc</code> 生成 <code>.node</code>文件被 <code>js</code>文件 <code>require</code> 使用都需要时间成本。</li> <li>这个时间可能会大于 <code>js</code> 直接运算的成本。</li></ul></li></ul></li></ul> <h4 id="_11-6-进程优化"><a href="#_11-6-进程优化" class="header-anchor">#</a> 11.6 进程优化</h4> <p><strong>利用计算机的多核 CPU 进行优化</strong></p> <h5 id="_11-6-1-node-js-中的进程和线程"><a href="#_11-6-1-node-js-中的进程和线程" class="header-anchor">#</a> 11.6.1 Node.js 中的进程和线程</h5> <ul><li><p>进程</p> <ul><li>操作系统挂载运行的独立单元
<ul><li>启动一个 <code>node.js</code> 程序就是启动了一个进程</li></ul></li> <li>拥有一些独立的资源，如内存等</li></ul> <p><img src="/awesome/assets/img/process.dbcd513c.jpg" alt="进程"></p></li> <li><p>线程</p> <ul><li><p>进程运算调度的单元</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 需要线程去执行运算</span>
</code></pre></div></li> <li><p>进程内的线程共享进程内的资源</p></li> <li><p>多核 <code>CPU</code></p> <ul><li>单个时间内可以执行多个计算，每个核心负责一个运算。</li></ul></li></ul></li> <li><p>举例</p> <ul><li>进程--公司</li> <li>线程--职员</li> <li>一对多的关系，公司（<small>提供资源</small>）发布指令，职员（<small>使用资源</small>）进行执行。</li></ul></li></ul> <h5 id="_11-6-2-node-js-子进程与线程"><a href="#_11-6-2-node-js-子进程与线程" class="header-anchor">#</a> 11.6.2 Node.js 子进程与线程</h5> <ul><li>事件循环（<small>举个例子</small>）
<ul><li>Node.js 是一个进程
<ul><li>创建一个主线程（老板）去运行 V8  和  JavaScript</li> <li>一般一个 Node.js 进程（公司）会创建 4 个子线程（职员）进行运算</li> <li>主线程（老板）一旦有任务可以处理，就会分配给子线程（职员）去处理
<ul><li>子线程（职员）处理主线程（老板）分配任务的过程中，主线程（老板）就去做别的事情</li> <li>一旦子线程（职员）处理完成，就报告（<small>回调函数</small>）主线程（老板），然后等着主线程（老板）分配任务。</li> <li>主线程（老板）和子线程（职员）不断的重复这个的过程，就是事件循环。</li></ul></li></ul></li></ul></li> <li>事件循环（<small>图片说明</small>）</li></ul> <p>尽管 <code>Node.js</code> 是高效的，主线程通过事件循环和 <code>libuv</code> 分配给子线程。这样就保障了主线程不会阻塞（异步操作都给了子线程去做）。</p> <p>但是当需要分配的任务非常多的时候一个主线程（老板）就不够用了。这个时候还是一个线程，还是单线程在执行任务。  只能利用 <code>CPU</code> 的一个核心就行运算，多核 <code>CPU</code> 就显得浪费。这个时候就需要 Node.js 的子进程和子线程了。</p> <p>相当于公司规模变大成为集团（进程），下面有多个子公司（主线程）。</p> <ul><li><p>父进程与子进程通信</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// master.js</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>

<span class="token comment">// 开启一个子进程</span>
<span class="token keyword">const</span> child_process <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>__dirname<span class="token operator">+</span><span class="token string">'/child.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 给子进程发送消息</span>
child_process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'我是父进程'</span><span class="token punctuation">)</span>

child_process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span><span class="token parameter">str</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'master.js 收到'</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>执行 <code>mater.js</code></p> <p>子进程接收消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// child.js</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span><span class="token parameter">str</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child.js 收到'</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'我是子进程'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这个时候子进程会一直在，发送后子进程不会退出不会中断，为了以后还有别的事情。</p> <p><img src="/awesome/assets/img/process_child.28d674a8.jpg" alt="子进程"></p></li></ul> <h4 id="_11-7-进程管理与守护"><a href="#_11-7-进程管理与守护" class="header-anchor">#</a> 11.7 进程管理与守护</h4> <h5 id="_11-7-1-开启多进程"><a href="#_11-7-1-开启多进程" class="header-anchor">#</a> 11.7.1 开启多进程</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;os&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 启动的时候根据 CPU 的核心数开启多个进程</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpus<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	 cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./app&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_11-7-2遇到错误-错误上报-退出并重启进程"><a href="#_11-7-2遇到错误-错误上报-退出并重启进程" class="header-anchor">#</a> 11.7.2遇到错误(错误上报)退出并重启进程</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;os&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpus<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
   <span class="token comment">// 监听主进程是否挂掉，挂掉 10 秒后重启</span>
  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;exit&quot;</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./app&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// 监控错误</span>
  process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;uncaughtException&quot;</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token comment">// 在这里可以进行错误上报</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// node 遇到错误的结束进程的时候需要返回 code=1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 监控是否有内存溢出</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 内存大于 700m 退出程序</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss <span class="token operator">&gt;</span> <span class="token number">734003200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里可以进行错误上报</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;内存溢出&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_11-7-3-判断进程是否处于僵尸状态-进程没断-但无法工作了"><a href="#_11-7-3-判断进程是否处于僵尸状态-进程没断-但无法工作了" class="header-anchor">#</a> 11.7.3 判断进程是否处于僵尸状态（进程没断，但无法工作了）</h5> <p><strong>心跳检测</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;os&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> missdPing <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpus<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> work <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      work<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;ping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      missdPing<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token comment">// 心跳检测主要为了子进程时候有死循环等</span>
      <span class="token comment">// 心跳超过 3 次未检测到，退出进程</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>missdPing <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;杀死僵死进程&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    work<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">===</span> <span class="token string">&quot;pong&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;pong&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        missdPing<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;exit&quot;</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 监听心跳事件，发送消息给主进程 进行呼应</span>
  process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token parameter">ping</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ping <span class="token operator">===</span> <span class="token string">&quot;ping&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;pong&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>missdPing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;uncaughtException&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss <span class="token operator">&gt;</span> <span class="token number">734003200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当子进程中出现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'死循环'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以杀死进程避免内存飙升。</p> <h3 id="_12-架构优化"><a href="#_12-架构优化" class="header-anchor">#</a> 12. 架构优化</h3> <h4 id="_12-1-动静分离"><a href="#_12-1-动静分离" class="header-anchor">#</a> 12.1 动静分离</h4> <ul><li><p>静态内容</p> <ul><li>基本不会变动，也不会因为请求参数不同而变化</li> <li>例如：脚本、样式、图片 ...</li> <li>解决方案：利用 <code>CDN</code> 加速，<code>HTTP</code> 缓存
<ul><li>CDN，当用户初次访问当前<code>cdn</code> 节点的时候该节点会向源站点发送请求，并缓存请求资源供下次使用。</li></ul></li> <li>一般用 <code>nginx</code> 进行转发，用 <code>node</code> 作为静态服务器的速度比不上 <code>nginx</code> <ul><li>二者性能相差一倍多</li></ul></li></ul></li> <li><p>动态内容</p> <ul><li><p>解决方案：加机器，结合 <code>nginx</code>反向代理、负载均衡</p></li> <li><p>缓存服务</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># nginx 反向代理 配置缓存</span>

upstream xxx.com <span class="token punctuation">{</span>
	server <span class="token number">127.0</span>.0.1:3000
	server <span class="token number">127.0</span>.0.1:3001
	<span class="token punctuation">..</span>.
<span class="token punctuation">}</span>
server<span class="token punctuation">{</span>
	<span class="token punctuation">..</span>.
  location ~ /user/<span class="token punctuation">(</span><span class="token punctuation">\</span>d*<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment"># 正则匹配请求 id 省的 node 层去匹配，性能优化</span>
    proxy_pass http://xxx.com/user/detail?colummid<span class="token operator">=</span><span class="token variable">$1</span><span class="token punctuation">;</span>
    proxy_cache 
  <span class="token punctuation">}</span>
  <span class="token punctuation">..</span>.
<span class="token punctuation">}</span>

</code></pre></div></li></ul></li></ul> <h4 id="_12-2-redis"><a href="#_12-2-redis" class="header-anchor">#</a> 12.2 redis</h4> <blockquote><p>原理：使用机器的内存作为存储。适合分布式部署共享数据。空间换时间。</p></blockquote> <p>通过异步调用取出 redis 的缓存内容，利用中间件获取缓存。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;redis&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;util&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getAsync <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 伪代码</span>
<span class="token comment">// 设置缓存</span>
client<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 取缓存</span>
client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token punctuation">{</span>expire<span class="token operator">:</span>xxx<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 让请求的 url 作为 key 取出对应 value </span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAsync</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="node-js-进阶-2"><a href="#node-js-进阶-2" class="header-anchor">#</a> Node.js 进阶</h1></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/awesome/assets/js/app.ca8b16c8.js" defer></script><script src="/awesome/assets/js/2.b179fbd3.js" defer></script><script src="/awesome/assets/js/5.6fad60fb.js" defer></script>
  </body>
</html>
