<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue 的运行机制简述 | Awesome-FE</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="个人笔记">
    <link rel="preload" href="/awesome/assets/css/0.styles.d47d1918.css" as="style"><link rel="preload" href="/awesome/assets/js/app.bdba70c4.js" as="script"><link rel="preload" href="/awesome/assets/js/2.2e371d65.js" as="script"><link rel="preload" href="/awesome/assets/js/11.06d3aa78.js" as="script"><link rel="prefetch" href="/awesome/assets/js/10.472a63d3.js"><link rel="prefetch" href="/awesome/assets/js/12.8a05e398.js"><link rel="prefetch" href="/awesome/assets/js/13.f61c2404.js"><link rel="prefetch" href="/awesome/assets/js/14.f6819ab0.js"><link rel="prefetch" href="/awesome/assets/js/15.8d91612d.js"><link rel="prefetch" href="/awesome/assets/js/16.07a86ae0.js"><link rel="prefetch" href="/awesome/assets/js/17.c6e4a048.js"><link rel="prefetch" href="/awesome/assets/js/18.dde65652.js"><link rel="prefetch" href="/awesome/assets/js/19.d781b9be.js"><link rel="prefetch" href="/awesome/assets/js/20.c34117b3.js"><link rel="prefetch" href="/awesome/assets/js/21.04e50b2c.js"><link rel="prefetch" href="/awesome/assets/js/22.d34e9024.js"><link rel="prefetch" href="/awesome/assets/js/23.90019082.js"><link rel="prefetch" href="/awesome/assets/js/24.579a35b5.js"><link rel="prefetch" href="/awesome/assets/js/25.46189b7b.js"><link rel="prefetch" href="/awesome/assets/js/26.01ae1256.js"><link rel="prefetch" href="/awesome/assets/js/27.13c213e8.js"><link rel="prefetch" href="/awesome/assets/js/28.ed0b544a.js"><link rel="prefetch" href="/awesome/assets/js/29.5d39e66c.js"><link rel="prefetch" href="/awesome/assets/js/3.9f420c01.js"><link rel="prefetch" href="/awesome/assets/js/30.45cce8b1.js"><link rel="prefetch" href="/awesome/assets/js/31.5bca6d99.js"><link rel="prefetch" href="/awesome/assets/js/32.d19290b5.js"><link rel="prefetch" href="/awesome/assets/js/33.09190d35.js"><link rel="prefetch" href="/awesome/assets/js/34.85a0361c.js"><link rel="prefetch" href="/awesome/assets/js/35.2698b130.js"><link rel="prefetch" href="/awesome/assets/js/36.656c6787.js"><link rel="prefetch" href="/awesome/assets/js/37.b5d2b125.js"><link rel="prefetch" href="/awesome/assets/js/38.179f3e18.js"><link rel="prefetch" href="/awesome/assets/js/39.aead283d.js"><link rel="prefetch" href="/awesome/assets/js/4.8fcdcea6.js"><link rel="prefetch" href="/awesome/assets/js/40.7469b451.js"><link rel="prefetch" href="/awesome/assets/js/41.56b39478.js"><link rel="prefetch" href="/awesome/assets/js/42.1a098e08.js"><link rel="prefetch" href="/awesome/assets/js/43.69f5036c.js"><link rel="prefetch" href="/awesome/assets/js/44.8c889fd3.js"><link rel="prefetch" href="/awesome/assets/js/45.cb9efd2b.js"><link rel="prefetch" href="/awesome/assets/js/46.13ff81c2.js"><link rel="prefetch" href="/awesome/assets/js/47.b471d5a4.js"><link rel="prefetch" href="/awesome/assets/js/48.385a517f.js"><link rel="prefetch" href="/awesome/assets/js/49.050f0b80.js"><link rel="prefetch" href="/awesome/assets/js/5.03775849.js"><link rel="prefetch" href="/awesome/assets/js/50.93008a3a.js"><link rel="prefetch" href="/awesome/assets/js/51.92ee6224.js"><link rel="prefetch" href="/awesome/assets/js/52.04fcc72d.js"><link rel="prefetch" href="/awesome/assets/js/53.0632b8b8.js"><link rel="prefetch" href="/awesome/assets/js/54.589dbafd.js"><link rel="prefetch" href="/awesome/assets/js/55.e3aa0bf9.js"><link rel="prefetch" href="/awesome/assets/js/56.9024ad4a.js"><link rel="prefetch" href="/awesome/assets/js/57.2f62afe6.js"><link rel="prefetch" href="/awesome/assets/js/58.e2c76987.js"><link rel="prefetch" href="/awesome/assets/js/59.b999010d.js"><link rel="prefetch" href="/awesome/assets/js/6.c9513411.js"><link rel="prefetch" href="/awesome/assets/js/60.d30eca61.js"><link rel="prefetch" href="/awesome/assets/js/61.0dde74e3.js"><link rel="prefetch" href="/awesome/assets/js/62.bb01837a.js"><link rel="prefetch" href="/awesome/assets/js/63.22b5dee5.js"><link rel="prefetch" href="/awesome/assets/js/64.3fcd843e.js"><link rel="prefetch" href="/awesome/assets/js/65.39dda720.js"><link rel="prefetch" href="/awesome/assets/js/66.cf1067ec.js"><link rel="prefetch" href="/awesome/assets/js/67.15b3f81b.js"><link rel="prefetch" href="/awesome/assets/js/68.9a3428a8.js"><link rel="prefetch" href="/awesome/assets/js/69.c52ebc6d.js"><link rel="prefetch" href="/awesome/assets/js/7.18c783d7.js"><link rel="prefetch" href="/awesome/assets/js/70.a177f1ce.js"><link rel="prefetch" href="/awesome/assets/js/71.d2fba163.js"><link rel="prefetch" href="/awesome/assets/js/72.48cabd87.js"><link rel="prefetch" href="/awesome/assets/js/73.0f6d406e.js"><link rel="prefetch" href="/awesome/assets/js/8.5f4af89c.js"><link rel="prefetch" href="/awesome/assets/js/9.76929cae.js">
    <link rel="stylesheet" href="/awesome/assets/css/0.styles.d47d1918.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/awesome/" class="home-link router-link-active"><!----> <span class="site-name">Awesome-FE</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/awesome/fn.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/awesome/bn.html" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/awesome/note.html" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="/awesome/interview.html" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="https://github.com/Composur" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/awesome/fn.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/awesome/bn.html" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/awesome/note.html" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="/awesome/interview.html" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="https://github.com/Composur" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue 的运行机制简述</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/awesome/vue.html#初始化" class="sidebar-link">初始化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/awesome/vue.html#this-init" class="sidebar-link">this._init()</a></li></ul></li><li><a href="/awesome/vue.html#vue-模板挂载" class="sidebar-link">Vue 模板挂载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/awesome/vue.html#运行时，和运行-编译时的挂载" class="sidebar-link">运行时，和运行+编译时的挂载</a></li></ul></li><li><a href="/awesome/vue.html#render-函数的生成" class="sidebar-link">render 函数的生成</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/awesome/vue.html#virtual-dom" class="sidebar-link">Virtual DOM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/awesome/vue.html#为什么需要-virtual-dom" class="sidebar-link">为什么需要 Virtual DOM</a></li><li class="sidebar-sub-header"><a href="/awesome/vue.html#vue-virtual-dom" class="sidebar-link">Vue Virtual DOM</a></li></ul></li><li><a href="/awesome/vue.html#总结-2" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/awesome/vue.html#mvvm运行机制" class="sidebar-link">MVVM运行机制</a></li><li class="sidebar-sub-header"><a href="/awesome/vue.html#vue-问题" class="sidebar-link">Vue 问题</a></li><li class="sidebar-sub-header"><a href="/awesome/vue.html#vuex-问题" class="sidebar-link">Vuex 问题</a></li><li class="sidebar-sub-header"><a href="/awesome/vue.html#vue-router-问题" class="sidebar-link">vue-router 问题</a></li><li class="sidebar-sub-header"><a href="/awesome/vue.html#vue-3-0" class="sidebar-link">Vue 3.0</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-的运行机制简述"><a href="#vue-的运行机制简述" class="header-anchor">#</a> Vue 的运行机制简述</h1> <h2 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h2> <p>这个阶段完成了全局方法（原型方法和静态方法）的定义：<code>state</code>、<code>component</code>、<code>lifecycle</code>、<code>dirctive</code> ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> initMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./init'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> stateMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./state'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./render'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eventsMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./events'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> lifecycleMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lifecycle'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> warn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>
<span class="token comment">// Vue 通过 new 一个函数来实现一个类，可以方便的往 Vue 原型上挂载方法</span>
<span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Vue is a constructor and should be called with the `new` keyword'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token comment">// Vue 原型上的方法</span>
<span class="token punctuation">}</span>
<span class="token comment">// 挂载，利于代码拆分，用 class  做不到这样</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Vue

</code></pre></div><h3 id="this-init"><a href="#this-init" class="header-anchor">#</a> this._init()</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm<span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
  	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="合并-options"><a href="#合并-options" class="header-anchor">#</a> 合并 <code>options</code></h4> <p>把我们传入的 <code>options</code> 合并到 <code>vm.$options</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
    <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
    options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    vm
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><h4 id="初始化事件、state、生命周期、注入、校验"><a href="#初始化事件、state、生命周期、注入、校验" class="header-anchor">#</a> 初始化事件、state、生命周期、注入、校验</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span> 
vm<span class="token punctuation">.</span>_self <span class="token operator">=</span> vm
 <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
 <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
 <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
 <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>
 <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve injections before data/props</span>
 <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
 <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve provide after data/props</span>
 <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
</code></pre></div><p><strong>为什么data{xx:'xx'}可以通过 this.xx 访问到？</strong></p> <p>请看下面 <code>initState(vm)</code> 的过程中调用 <code>initData</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initData</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data
  
  <span class="token comment">// 判断是否是 function 推荐函数的写法 data(){return {}} 每次调用返回一个新对象</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token comment">// proxy data on instance</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props
  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods
  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length
  
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
  	<span class="token comment">// dev 警告</span>
    <span class="token comment">// props 的 key 和 methods 的 key 不能重复</span>
    <span class="token comment">// 因为它们最后都要挂载到 vm 上所以不能重复</span>
    <span class="token operator">...</span>
    <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">// 详见下面</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 观察 data</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它将 <code>options.data</code> 对象中的所有的属性加入到 <code>Vue</code> 的<strong>响应式系统</strong>中。当这些属性的值发生改变时，视图将会产生“响应”，即匹配更新为新的值。</p> <p><strong>proxy</strong> 为访问 <code>data</code> 属性做了一层代理</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">//  targe = vm ; sourceKey= _data </span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">proxy</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Object<span class="token punctuation">,</span> sourceKey<span class="token operator">:</span> string<span class="token punctuation">,</span> key<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxyGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// return this._data.key</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxySetter</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
  <span class="token punctuation">}</span>
  

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedPropertyDefinition<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 我们访问 data 上的 message 属性</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>message 等价于 <span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">.</span>message
</code></pre></div><h4 id="挂载"><a href="#挂载" class="header-anchor">#</a> 挂载</h4> <ul><li>在 <code>this._init()</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm<span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
  	<span class="token operator">...</span>
  	 <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <p>Vue 初始化主要就干了几件事情，合并配置，初始化生命周期，初始化事件中心，初始化渲染，初始化 data、props、computed、watcher 等</p> <h2 id="vue-模板挂载"><a href="#vue-模板挂载" class="header-anchor">#</a> Vue 模板挂载</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="运行时，和运行-编译时的挂载"><a href="#运行时，和运行-编译时的挂载" class="header-anchor">#</a> 运行时，和运行+编译时的挂载</h3> <p><strong>初始化后，调用 <code>$mount</code> 方法对 Vue 实例进行挂载（挂载的核心过程包括</strong>模板编译**、<strong>渲染</strong>以及<strong>更新</strong>三个过程）。**</p> <blockquote><p>如果没有在实例上定义<code>render</code>方法，而是定义了<code>template</code>,那么是需要编译的。先将<code>template</code> 字符串编译成 <code>render function</code>。</p></blockquote> <p>组件挂载二者都是调用 <code>mountComponent()</code> 进行挂载，不同的是编译版本，多了对节点的编译处理。</p> <h4 id="运行-编译"><a href="#运行-编译" class="header-anchor">#</a> 运行+编译</h4> <p><code>entry-runtime-with-compiler.js</code> 中具体的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">el<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>

  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// #app</span>
          template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token comment">// 获取 dom </span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token comment">// dom 字符串</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 进行编译</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        outputSourceRange<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
        shouldDecodeNewlines<span class="token punctuation">,</span>
        shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
        delimiters<span class="token operator">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>
        comments<span class="token operator">:</span> options<span class="token punctuation">.</span>comments
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      options<span class="token punctuation">.</span>render <span class="token operator">=</span> render
      options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 这个 mount 就是上面缓存 Vue.prototype.$mount 就是下面的 Vue.prototype.$mount</span>
  <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>parse</code> 正则解析 <code>template</code> 字符串形成 AST（抽象语法树，是源代码的抽象语法结构的树状表现形式）</li> <li><code>optimize</code> 标记静态节点</li> <li><code>generate</code> 将 AST 转化成 <code>render function</code> 字符串</li></ul> <h4 id="运行时"><a href="#运行时" class="header-anchor">#</a> 运行时</h4> <p>项目大多采用这个版本</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">el<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span>
  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="挂载-2"><a href="#挂载-2" class="header-anchor">#</a> 挂载</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span> <span class="token punctuation">(</span>
  <span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span>
  el<span class="token operator">:</span> <span class="token operator">?</span>Element<span class="token punctuation">,</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  
  vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render <span class="token operator">=</span> createEmptyVNode
  <span class="token punctuation">}</span>
  
  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeMount'</span><span class="token punctuation">)</span> <span class="token comment">// 先执行 beforeMount 生命周期函数</span>

  <span class="token keyword">let</span> updateComponent

  <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 观察者</span>
  <span class="token comment">// 1、实例化一个 Watcher ，初始化的时候执行 vm._render()</span>
  <span class="token comment">// 2、监测数据变化，调用更新</span>
  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// noop 是空函数</span>
    <span class="token function">before</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span><span class="token punctuation">)</span>
  
  hydrating <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 根实例为 null</span>
    vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span> 
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span> <span class="token comment">// 挂载成功执行 'mounted' 生命周期函数</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre></div><h2 id="render-函数的生成"><a href="#render-函数的生成" class="header-anchor">#</a> render 函数的生成</h2> <p><code>_render</code> 是内部的私有方法</p> <p>调用 <code>render</code> 方法将 <code>render function</code> 渲染成虚拟的 Node ,<code>render</code> 方法的第一个参数是 <code>createElement</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span> <span class="token comment">// 返回一个 VNode</span>
    <span class="token keyword">const</span> vm<span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> _parentVnode <span class="token punctuation">}</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_parentVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>$scopedSlots <span class="token operator">=</span> <span class="token function">normalizeScopedSlots</span><span class="token punctuation">(</span>
        _parentVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>scopedSlots<span class="token punctuation">,</span>
        vm<span class="token punctuation">.</span>$slots<span class="token punctuation">,</span>
        vm<span class="token punctuation">.</span>$scopedSlots
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    vm<span class="token punctuation">.</span>$vnode <span class="token operator">=</span> _parentVnode
    <span class="token comment">// render self</span>
    <span class="token keyword">let</span> vnode
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      currentRenderingInstance <span class="token operator">=</span> vm
      vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">render</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
     
      vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode
      
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      currentRenderingInstance <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// if the returned array contains only a single node, allow it</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vnode <span class="token operator">=</span> vnode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// return empty vnode in case the render function errored out</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>vnode <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vnode <span class="token operator">=</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// set parent</span>
    vnode<span class="token punctuation">.</span>parent <span class="token operator">=</span> _parentVnode
    <span class="token keyword">return</span> vnode
  <span class="token punctuation">}</span>
</code></pre></div><p><code>vm.$createElement</code> 主要是用来处理我们传入的 <code>render</code> 方法</p> <p>例如：</p> <div class="language-vue extra-class"><pre class="language-vue"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span>  <span class="token parameter">createElement</span><span class="token operator">=&gt;</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
		attrs<span class="token operator">:</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span><span class="token string">'app'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
// render 等价于
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>#app<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>{{message}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="virtual-dom"><a href="#virtual-dom" class="header-anchor">#</a> Virtual DOM</h2> <blockquote><p>虚拟 DOM 不是真实的 DOM，是一种用 JS 描述 DOM 节点的数据结构。</p></blockquote> <h3 id="为什么需要-virtual-dom"><a href="#为什么需要-virtual-dom" class="header-anchor">#</a> 为什么需要 Virtual DOM</h3> <p>我们先看一浏览器是怎么绘制<code>DOM</code>的</p> <p>1、创建<code>DOM</code>树 2、创建<code>style rules</code> 3、构建 <code>Render</code> 树 4、布局 <code>Layout</code> 5、绘制 <code>Painting</code></p> <ul><li>第一步，构建 <code>DOM</code> 树，用 <code>HTML</code> 分析器，分析 <code>HTML</code> ，生成一颗 <code>DOM</code> 树</li> <li>第二步，构建 <code>CSS</code> 样式表，用 <code>CSS</code> 分析器，分析 <code>.css</code> 文件和 <code>inline</code> 样式 ，生成样式表</li> <li>第三步，构建 <code>Render</code> 树，将 <code>DOM</code> 树和样式表关联起来生成 <code>Render</code> 树，每个 <code>DOM</code> 节点都有<code>attach</code> 方法用于接收新的样式，它返回一个 <code>render</code> 对象，最终被构建成 <code>Render</code>树</li> <li>第四步，确定<code>DOM</code> 节点在浏览器上的位置，根据 <code>Render</code> 树和节点坐标，调用节点的 <code>paint</code> 方法进行绘制</li></ul> <p>我们再看一下真实的 <code>DOM</code> 节点挂载了多少属性</p> <div class="language-js extra-class"><pre class="language-js"><code>count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> app<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// app 是一个 dom 节点</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    count<span class="token operator">++</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试结果为 <code>count</code> 值为 289，每次操作更新 <code>DOM</code> 都要带上他们，重复执行绘制<code>DOM</code>的步骤，如节点很多（上万），加上浏览器回流，就会产生一定的渲染性能问题（卡顿）。</p> <h3 id="vue-virtual-dom"><a href="#vue-virtual-dom" class="header-anchor">#</a> Vue Virtual DOM</h3> <blockquote><p><code>Vue.js</code> 中 <code>Virtual DOM</code> 是借鉴了一个开源库  <a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">snabbdom<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的实现，然后加入了一些 <code>Vue.js</code> 的一些特性，也是为了跨平台。weex...等其它平台，元素的 dom 不可以。</p></blockquote> <h4 id="vnode"><a href="#vnode" class="header-anchor">#</a> VNode</h4> <p>这里简化了只留了比较重要的属性，它是对真实 <code>DOM</code> 的抽象描述。</p> <p><code>src/core/vdom/vnode.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter">tag<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    data<span class="token operator">?</span><span class="token operator">:</span> VNodeData<span class="token punctuation">,</span>
    children<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    text<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    elm<span class="token operator">?</span><span class="token operator">:</span> Node<span class="token punctuation">,</span>
    context<span class="token operator">?</span><span class="token operator">:</span> Component<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag  <span class="token comment">// 标签名</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data <span class="token comment">// // 节点属性，事件等</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> children <span class="token comment">// vnode 子节点</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text <span class="token comment">// 元素文本</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>elm <span class="token operator">=</span> elm <span class="token comment">// 对应的真实 dom</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>key <span class="token comment">// vnode 标记方便 dom diff</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">child</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentInstance
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="createelement"><a href="#createelement" class="header-anchor">#</a> CreateElement</h4> <p><code>render</code> 无论是处理模板编译出来的 <code>render</code> 函数，还是处理我们手写的 <code>render</code> 函数都需要进行，c<code>reateElement</code> 函数，而这个函数又调用了内部的私有方法 <code>_createElement</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span> <span class="token punctuation">(</span>
 	<span class="token comment">//</span>
  <span class="token keyword">return</span> <span class="token function">_createElement</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> normalizationType<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>_createElement</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">_createElement</span> <span class="token punctuation">(</span>
  context<span class="token operator">:</span> Component<span class="token punctuation">,</span> <span class="token comment">// 作用域 上下文</span>
  tag<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> Function <span class="token operator">|</span> Object<span class="token punctuation">,</span> <span class="token comment">// 标签</span>
  data<span class="token operator">?</span><span class="token operator">:</span> VNodeData<span class="token punctuation">,</span> <span class="token comment">// 节点和属性 {id:'',class:''}</span>
  children<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  normalizationType<span class="token operator">?</span><span class="token operator">:</span> number
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token operator">|</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// object syntax in v-bind</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tag <span class="token operator">=</span> data<span class="token punctuation">.</span>is
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// in case of component :is set to falsy value</span>
    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// support single function children as default scoped slot</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    data<span class="token punctuation">.</span>scopedSlots <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
    children<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizationType <span class="token operator">===</span> <span class="token constant">ALWAYS_NORMALIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render 函数不是编译产生的</span>
    children <span class="token operator">=</span> <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizationType <span class="token operator">===</span> <span class="token constant">SIMPLE_NORMALIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// render 函数是编译产生的</span>
    children <span class="token operator">=</span> <span class="token function">simpleNormalizeChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> vnode<span class="token punctuation">,</span> ns
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> Ctor
    ns <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ns<span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">getTagNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建虚拟 DOM</span>
      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span><span class="token function">parsePlatformTagName</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> context
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>Ctor <span class="token operator">=</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// component</span>
      vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// unknown or unlisted namespaced elements</span>
      <span class="token comment">// check at runtime because it may get assigned a namespace when its</span>
      <span class="token comment">// parent normalizes children</span>
      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>
        tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> context
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// direct component options / constructor</span>
    vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> vnode
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">applyNS</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> ns<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">registerDeepBindings</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vnode
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看一下打印出的 <code>VNode</code> 节点</p> <h4 id="update"><a href="#update" class="header-anchor">#</a> Update</h4> <p>被调用的时机：</p> <ul><li>首次渲染的时候</li> <li>数据更新的时候</li></ul> <p>首次渲染</p> <div class="language-js extra-class"><pre class="language-js"><code>
vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* removeOnly */</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>vm.$el</code> 是 <code>&lt;div id='#app'&gt;&lt;/div&gt;</code></li> <li><code>vnode</code> 是 <code>render</code> 函数的返回值</li> <li><code>hydrating</code>是是否服务端渲染</li></ul> <p>Patch 函数的执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 主要是调用了 createElm 方法，创建真实的 node </span>
<span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">createElm</span><span class="token punctuation">(</span>
    vnode<span class="token punctuation">,</span>
    insertedVnodeQueue<span class="token punctuation">,</span>
    <span class="token comment">// extremely rare edge case: do not insert if old element is in a</span>
    <span class="token comment">// leaving transition. Only happens when combining transition +</span>
    <span class="token comment">// keep-alive + HOCs. (#4590)</span>
    oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> parentElm<span class="token punctuation">,</span>
    nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>createElm</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createElm</span> <span class="token punctuation">(</span>
  <span class="token parameter">vnode<span class="token punctuation">,</span>
  insertedVnodeQueue<span class="token punctuation">,</span>
  parentElm<span class="token punctuation">,</span>
  refElm<span class="token punctuation">,</span>
  nested<span class="token punctuation">,</span>
  ownerArray<span class="token punctuation">,</span>
  index</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 主要执行了</span>
    <span class="token comment">// 创建子组件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">createComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
    <span class="token comment">// 创建子元素 nodeOps 的方法都是一些实际的 dom 操作</span>
    vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>ns
      <span class="token operator">?</span> nodeOps<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>ns<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
      <span class="token operator">:</span> nodeOps<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token function">setScope</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h2> <p><img src="/awesome/assets/img/new-vue.9f257f78.png" alt="new-vue"></p> <p><code>new Vue</code> → <code>init</code> → <code>$mount</code> → <code>complie</code> → <code>render</code> → <code>vnode</code> → <code>patch</code> → <code>DOM</code></p> <p>因为我们在挂载节点的时候实例化了一个 <code>Watcher</code>来监测数据的变化，一旦响应式系统中的数据发生了变化，负责收集依赖管理的 <code>Dep</code> 就会执行 <code>dep.notify()</code> 通知 <code>Watcher</code> ，<code>Watcher</code>再调用 <code>updateComponent</code> 方法更新。</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// noop 是空函数</span>
    <span class="token function">before</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span><span class="token punctuation">)</span>
</code></pre></div><p>通过 <code>VNode</code>类生成的节点就是我们在初始化挂载</p> <h5 id="_3-1-5-什么是-patch？"><a href="#_3-1-5-什么是-patch？" class="header-anchor">#</a> 3.1.5  什么是 patch？</h5> <ul><li><p>生成虚拟 DOM 树后，需要将虚拟 DOM 树转化成真实的 DOM 节点，此时需要调用<code>update</code>方法，<code>update</code>方法又会调用<code>pacth</code>方法把虚拟 DOM 转换成真正的 DOM 节点。</p></li> <li><p>如果没有旧的虚拟 Node 直接通过<code>createElm</code>创建真实 DOM 节点，否则会通过<code>sameVnode</code>判断当前需要更新的 Node 节点是否和旧的 Node 节点相同（因为有key）。节点不同直接替换，否则调用 <code>patchVNode</code> 方法执行 diff 算法更新 DOM。</p></li></ul> <h4 id="_2-响应式流程（数据更新策略、依赖收集）"><a href="#_2-响应式流程（数据更新策略、依赖收集）" class="header-anchor">#</a> 2. 响应式流程（数据更新策略、依赖收集）</h4> <ul><li><code>vue.js</code> 在初始化的时候采用数据劫持结合发布者-订阅者模式的方式，通过<code>Object.defineProperty()</code> 来劫持各个属性的 <code>setter</code>，<code>getter</code></li> <li>当 <code>render function</code> 被渲染的时候，会读取 Vue 实例中和视图相关的响应式数据，此时会触发<code>getter</code> 函数进行<strong>依赖收集</strong>（将观察者 <code>Watcher</code> 对象存放到当前闭包的订阅者 <code>Dep</code> 的 <code>subs</code>中）</li> <li>在数据变动时发布消息给订阅者，触发相应的监听回调即触发数据劫持的<code>setter</code>函数。<code>setter</code>会通知初始化<strong>依赖收集</strong>中的 <code>Dep</code> 中的和视图相应的 <code>Watcher</code> ，告知需要重新渲染视图，<code>Wather</code>就会再次通过 <code>update</code> 方法来更新视图。</li></ul> <ol><li>如何形成 AST ？</li> <li>混入 、$options，vuex、router 他们各自如何通过这些api，实现各自的功能？</li></ol> <h3 id="mvvm运行机制"><a href="#mvvm运行机制" class="header-anchor">#</a> MVVM运行机制</h3> <blockquote><p><code>vue.js</code> 采用数据劫持结合发布者-订阅者模式的方式，通过<code>Object.defineProperty()</code>来劫持各个属性的<code>setter</code>，<code>getter</code>，在数据变动时发布消息给订阅者，触发相应的监听回调.</p></blockquote> <p>​	<code>MVVM</code> 作为入口，整合了 <code>observer</code> 、 <code>compile</code> 、 <code>watcher</code> 。通过 <code>observer</code> 来监视 <code>model</code> 的变化，通过 <code>compile</code> 来编译指令模板。利用 <code>watcher</code> 来搭建 <code>observer</code> 、<code>compile</code>、之间的桥梁。</p> <p>​	这样就达到了：数据变化 → 视图更新。视图更新 → 数据变化 → 视图更新。</p> <p><img src="/awesome/assets/img/WeChatcdec629d4babf2a5dc7b07850a351b72.cdec629d.png" alt=""></p> <h4 id="_1-实例化-vue"><a href="#_1-实例化-vue" class="header-anchor">#</a> 1. 实例化 Vue</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token operator">=</span> options<span class="token punctuation">.</span>el
    <span class="token keyword">this</span><span class="token punctuation">.</span>$data <span class="token operator">=</span> options<span class="token punctuation">.</span>data
    <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1.数据劫持 observe</span>
      <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
      <span class="token comment">// 2.指令解析 compile</span>
      <span class="token keyword">new</span> <span class="token class-name">Compile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token comment">// 3. 代理一下 this.$data.obj === this.obj</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">proxyData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">proxyData</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">return</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
          data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>数据劫持（<code>observer</code>）</p> <ul><li><p>遍历所有的对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 递归对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 数据劫持 和 Dep 关联起来</span>
            Dep<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span>  dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
            <span class="token keyword">return</span> value
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 数据劫持</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token comment">// 让修改后的值有 get set 方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 调用监视者 去更新视图</span>
              value <span class="token operator">=</span> newValue

            <span class="token punctuation">}</span>
             <span class="token comment">// 通知 Dep 让 Dep 在通知 watcher </span>
             dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>数据编译（<code>compile</code>）</p> <ul><li><p>遍历所有节点放入 <code>fragment</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">fragment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> childNodes <span class="token operator">=</span> fragment<span class="token punctuation">.</span>childNodes<span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token operator">...</span>childNodes<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断每个节点的类型，是元素还是文本，分别进行处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isNodeElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log('元素',child)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log('文本', child)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileText</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 递归</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <h4 id="_2-dep"><a href="#_2-dep" class="header-anchor">#</a> 2. Dep</h4> <p>关联 Observer 和 Watcher</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// 1. 通知 observe(观察者)) 数据变化</span>
<span class="token comment">// 2. 添加订阅（搜集 watcher）</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历观察者</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'所有的观察者'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">watcher</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在这里调用需要更新的观察者</span>
      watcher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="_3-watcher"><a href="#_3-watcher" class="header-anchor">#</a> 3. Watcher</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 观察者</span>
<span class="token comment">// 比较新值和旧值</span>
<span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span> <span class="token comment">// 什么时候绑定？ 在解析、更新数据的时候</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">expr<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>expr <span class="token operator">=</span> expr
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOldValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如何得到</span>
    <span class="token comment">// 调用 watcher 的 update 方法后得到的就是新值</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> compilUtil<span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expr<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>oldValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">getOldValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如何得到？</span>
    <span class="token comment">// compilUtil.getVal()</span>

    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token comment">//这里定义当前数据的 watcher</span>
    <span class="token keyword">const</span> oldValue <span class="token operator">=</span> compilUtil<span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expr<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>  <span class="token comment">// 得到数据就销毁</span>
    <span class="token keyword">return</span> oldValue
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>observe - dep - watcher - view</p> <h3 id="vue-问题"><a href="#vue-问题" class="header-anchor">#</a> Vue 问题</h3> <h4 id="_1-组件化"><a href="#_1-组件化" class="header-anchor">#</a> 1. 组件化</h4> <ol><li><p>构造</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">const</span> component <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     templete<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>语法糖注册方式</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'my-component'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
     templete<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>注册
$ 全局注册</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'my-component'</span><span class="token punctuation">,</span>component<span class="token punctuation">)</span>
</code></pre></div><p>$ 实例下注册的组件是局部组件</p></li> <li><p>使用</p> <ul><li>在创建的实例中使用</li></ul></li></ol> <h5 id="_1-1-data-必须是一个函数"><a href="#_1-1-data-必须是一个函数" class="header-anchor">#</a> 1.1 <a href="https://cn.vuejs.org/v2/guide/components.html#data-%E5%BF%85%E9%A1%BB%E6%98%AF%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer"><code>data</code> 必须是一个函数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h5> <p><strong>一个组件的 <code>data</code> 选项必须是一个函数</strong>，因此每个实例可以维护一份被返回对象的独立的拷贝：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    count<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_1-2-父子组件传参"><a href="#_1-2-父子组件传参" class="header-anchor">#</a> 1.2 父子组件传参</h5> <ul><li><p>父传子，通过 props</p></li> <li><p>在子组件绑定 props <code>v-bind:children-data='data'</code> <small>暂不支持驼峰命名</small></p></li> <li><p>子传父，通过自定义事件 <code>$emit(events)</code> 发射一个事件</p> <ul><li>在子组件通过 <code>this.$emit('事件名',obj)</code> <small>事件名不支持驼峰命名</small></li> <li>父组件上监听 <code>v-on:事件名=methods</code> 父组件方法中获取<code>methods($event)</code> 获取 <code>obj</code></li></ul></li> <li><p>双向数据绑定的时候</p> <ul><li><p>子组件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'update:title'</span><span class="token punctuation">,</span> newTitle<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>父组件监听事件并更新本地属性继而更新传递给子组件的 <code>prop</code></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text-document</span>
  <span class="token attr-name"><span class="token namespace">v-bind:</span>title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>doc.title<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name"><span class="token namespace">v-on:</span><span class="token namespace">update:</span>title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>doc.title = $event<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text-document</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>简写</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text-document</span>
  <span class="token attr-name">:title.sync</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>doc.title<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text-document</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul></li></ul> <h5 id="_1-3-批量全局注册"><a href="#_1-3-批量全局注册" class="header-anchor">#</a> 1.3 批量全局注册</h5> <p>以 icon 组件 为例 全局注册 动态引入 icon 文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> SvgIcon <span class="token keyword">from</span> <span class="token string">'@/components/SvgIcon'</span><span class="token comment">// svg component</span>

<span class="token comment">// register globally</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'svg-icon'</span><span class="token punctuation">,</span> SvgIcon<span class="token punctuation">)</span>
 <span class="token comment">// false 是否查询其子目录</span>
<span class="token keyword">const</span> req <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">'./svg'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token regex">/\.svg$/</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">requireAll</span> <span class="token operator">=</span> <span class="token parameter">requireContext</span> <span class="token operator">=&gt;</span> requireContext<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>requireContext<span class="token punctuation">)</span>
<span class="token function">requireAll</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
<span class="token comment">// 记住全局注册的行为必须在根 Vue 实例 (通过 new Vue) 创建之前发生</span>
</code></pre></div><h4 id="_2-slot-插槽"><a href="#_2-slot-插槽" class="header-anchor">#</a> 2. slot/插槽</h4> <blockquote><p>原理类似电脑上的 use 电源 耳机 插槽等，让使用者（一般是父组件传入的html模板）决定怎么使用 这是具名插槽</p></blockquote> <div class="language-vue extra-class"><pre class="language-vue"><code>//子组件
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>header<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>

//父组件
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HeaderTop</span> <span class="token attr-name">:title</span><span class="token attr-value"><span class="token punctuation">=</span>address</span> <span class="token attr-name">showIcon</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>header_search<span class="token punctuation">&quot;</span></span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>iconfont iconicon_shaoma_xian<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>header_login<span class="token punctuation">&quot;</span></span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>iconfont iconicon-xiaoxi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HeaderTop</span><span class="token punctuation">&gt;</span></span>


</code></pre></div><p>1). 插槽的作用:
父组件向子组件传递标签结构(也可以是数据)
通过标签体传递, 而不再是标签属性
2). slot的分类
普通插槽(slot)
命名插槽(named slot)
作用域插槽(scoped slot)（数据由子组件决定，样式由父组件决定）</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!--父 获取数据--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">:slot-scope</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    //do
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--子 传递数据--&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">:data</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>data<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>3). 区别
普通插槽: 子组件只能有一个插槽, 标签体内容在父组件中解析好后(数据在父组件), 传递给这个插槽
命名插槽: 子组件有多个指定了name的插槽, 标签体内容在父组件中解析好后(数据在父组件), 分别传递给对应的插槽
作用域插槽: 数据在子组件, 子组件有部分结构需要父组件传递, 但父组件需要读取子组件数据
子组件需要先向父组件传递数据, 父组件根据数据渲染标签结构后传递给子组件的插槽
需求: todo列表组件: 根据内部的todos数据显示todo列表, 但列表项的样式由使用者决定</p> <h4 id="_3-mixin-混合"><a href="#_3-mixin-混合" class="header-anchor">#</a> 3. mixin/混合</h4> <div class="language- extra-class"><pre><code>1). 作用:
    复用多个组件重复的JS代码(配置)
    一个mixin是一个可复用的组件配置对象
2). 定义mixin
    var myMixin = {
      data () {
        return {
          a: 'a1111',
        }
      },
      computed: {
        length () {
          return this.a.length
        }
      }
    }
3). 多组件中引入mixin
    通过mixins配置引用: mixins: [myMixin]
    mixin中的配置与当前组件的配置会自动合并
</code></pre></div><h4 id="_4-动态组件-缓存组件-异步组件"><a href="#_4-动态组件-缓存组件-异步组件" class="header-anchor">#</a> 4. 动态组件 / 缓存组件 / 异步组件</h4> <div class="language- extra-class"><pre><code>1). 动态组件
    通过&lt;component :is=&quot;componentName&quot;&gt;来动态决定渲染哪个组件
    被切换的组件默认会被自动销毁
2). 缓存组件
    通过&lt;keep-alive&gt;来缓存被切换的动态组件(非路由组件)
    也可以缓存路由组件
3). 异步组件
    在需要组件时, 才异步请求加载组件的代码(从后台)
    Vue 能够将组件定义为一个工厂函数(factory function)，此函数可以异步地解析(resolve)组件
    import()的语法比较适合的是路由组件的异步懒加载
</code></pre></div><h4 id="_5-原生事件-vue自定义事件-全局事件总线"><a href="#_5-原生事件-vue自定义事件-全局事件总线" class="header-anchor">#</a> 5. 原生事件 / vue自定义事件 / 全局事件总线</h4> <div class="language- extra-class"><pre><code>1). 什么条件下绑定的原生DOM事件监听?
    a. 给html标签绑定dom事件监听: &lt;div =&quot;handleClick&quot;&gt;
    b. 给组件标签绑定dom事件监听(使用.native): &lt;MyCommponent @click.native=&quot;handleClick&quot;&gt;
2). 什么条件下绑定的vue自定义事件监听?
    a. 自定义事件名:  &lt;MyComponent @xxx=&quot;handleClick2&quot;&gt;
    b. 与dom事件名同名: &lt;MyComponent @click=&quot;handleClick&quot;&gt;
3). 利用vm实现全局eventBus
    a. 前置知识:
        Vue原型对象上有3个事件处理的方法: $on() / $emit() / $off()
        组件对象的原型对象是一个vm对象: 组件对象可以直接访问Vue原型对象上的方法
    b. 实现
        创建vm作为全局事件总线对象: Vue.prototype.$bus = new Vue()
        分发事件/传递数据的组件: this.$bus.$emit('eventName', data)
        处理事件/接收数据的组件: this.$bus.$on('eventName', (data) =&gt; {})
</code></pre></div><h4 id="_6-使用组件标签上使用v-model"><a href="#_6-使用组件标签上使用v-model" class="header-anchor">#</a> 6. 使用组件标签上使用v-model</h4> <div class="language- extra-class"><pre><code>1). v-model的本质
    &lt;input v-model=&quot;name&quot;&gt;
    &lt;input :value=&quot;name&quot; @input=&quot;name = $event.target.value&quot;&gt;
2). 在自定义组件上使用v-model
    &lt;MyInput v-model=&quot;name&quot;&gt;
    MyInput.vue
        props: ['value']
        &lt;input :value='value' @input=&quot;$emit('input', $event.target.value)&quot;&gt;
</code></pre></div><h4 id="_7-vue的响应式原理"><a href="#_7-vue的响应式原理" class="header-anchor">#</a> 7. vue的响应式原理</h4> <blockquote><p>Vue在进行DOM渲染时会尽可能的复用已经存在的的元素，而不是重新创建元素。强制不使用的话就加一个key。
1). 关注点有哪些?
vue的数据绑定效果: 组件更新data数据后, 当前组件及相关的子组件都会更新相应的节点
如何知道数据变化了?
通知哪些组件更新渲染?
组件更新渲染是同步还是异步的?</p></blockquote> <div class="language- extra-class"><pre><code>2). 基本原理
    在初始化时: 利用Object.defineProperty()给data属性添加 setter 监视数据变化
    在初始化时: 每个组件实例都有相应的观察者 watcher 对象, 每个属性都关联上所有相关的watcher对象
    在更新数据后: 对应的setter调用, 通知所有相关的watcher, watcher内异步更新节点或者子组件

3). 一些细节
</code></pre></div><blockquote><p>数据上的一些方式是响应式的，通过数组的下标去更改数组的值做不到响应式（vue没有通过这种方式监听）
只有data中属性是响应式的, 只在组件对象上的属性不是响应式的
data中所有层次属性都是响应式的
直接能data中响应式属性对象添加一个新的属性, 默认不是响应式的, 需要用Vue提供的语法添加
Vue.set(obj, propName, value)
vm.$set(obj, propName, value)
vue的异步更新:
vue 在内部尝试对异步队列使用原生的 Promise.then 和 MessageChannel，
如果执行环境不支持，会采用 setTimeout(fn, 0) 代替
index页面中的的div元素会被替换, 而不是插入其中
组件的data配置不能是对象?
组件会被多次使用, 每次使用都会读取data配置值, 如果是对象, 那就会共用一个data对象
而函数就没有问题, 因为每次调用函数返回一个新的data对象</p></blockquote> <h4 id="_8-组件的生命周期"><a href="#_8-组件的生命周期" class="header-anchor">#</a> 8. 组件的生命周期</h4> <p>vue的生命周期:  创建 =&gt; 挂载 =&gt; 更新 =&gt; 销毁</p> <ul><li>初始化(一次): <code>beforeCreate() =&gt; created() =&gt; beforeMount() =&gt; mounted()</code></li> <li>更新(n次):  <code>beforeUpdate()</code> =&gt; <code>updated()</code></li> <li>销毁(一次): <code>beforeDestroy() =&gt; destroyed()</code></li></ul> <p>各个生命周期的作用：</p> <ul><li><code>beforeCreate()</code> : 在实例初始化之后，立即同步调用，在数据观察 <code>(data observer)</code>和 <code>event/watcher</code> 事件配置之前被调用。</li> <li><code>created()</code> : 可以读取或修改 <code>data</code> 中的数据, 已经完成数据观察 <code>(data observer)</code>和 <code>event/watcher</code> 事件回调。然而，挂载阶段还没开始，<code>$el</code> 属性目前尚不可用。</li> <li><code>beforeMount()</code> : 模板已经在内存中编译, 但还没有挂载到页面上, 不能通过 <code>ref</code> 找到对应的标签</li> <li><code>mounted()</code>: 页面已经初始显示, 可以通过ref找到对应的标签。如希望整个视图都重绘完毕可以在 <code>mounted</code> 里使用 <a href="https://cn.vuejs.org/v2/api/#vm-nextTick" target="_blank" rel="noopener noreferrer">vm.$nextTick<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>beforeUpdate()</code> : 在数据更新之后, 界面更新前调用, 只能访问到原有的界面。适合在更新之前访问现有的 <code>DOM</code>，比如手动移除已添加的事件监听器。</li> <li><code>updated()</code> : 在界面更新之后调用, 此时可以访问最新的界面。然而在大多数情况下，你应该避免在此期间更改状态。如果要相应状态改变，通常最好使用<a href="https://cn.vuejs.org/v2/api/#computed" target="_blank" rel="noopener noreferrer">计算属性<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或 <a href="https://cn.vuejs.org/v2/api/#watch" target="_blank" rel="noopener noreferrer">watcher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 取而代之。注意 <code>updated</code> <strong>不会</strong>保证所有的子组件也都一起被重绘。如希望整个视图都重绘完毕可以在 <code>updated</code> 里使用 <a href="https://cn.vuejs.org/v2/api/#vm-nextTick" target="_blank" rel="noopener noreferrer">vm.$nextTick<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>beforeDestroy()</code>: 实例销毁之前调用, 此时实例仍然完全可用。</li> <li><code>destroyed()</code> : <code>Vue</code> 实例销毁后调用, 数据绑定/事件监听器都没了, 但 <code>Dom</code>结构还在。</li> <li><code>deactivated()</code> : 路由组件失活, 但没有死亡。</li> <li><code>activated()</code> : 路由组件激活, 被复用。</li></ul> <h4 id="_9-组件缓存-keep-alive"><a href="#_9-组件缓存-keep-alive" class="header-anchor">#</a> 9. 组件缓存 keep-alive</h4> <ol><li>获取<code>keep-alive</code>对象包括的第一个子组件对象</li> <li>根据白黑名单(inclued excude)是否匹配返回本身的<code>vnode</code></li> <li>根据<code>vnode</code>的<code>cid</code>和<code>tag</code>生成的<code>key</code>，在缓存对象中是否有当前缓存，如果有则返回，并更新<code>key</code>在<code>keys</code>中的位置</li> <li>如果当前缓存对象不存在缓存，就往<code>cache</code>添加这个的内容，并且根据<code>LRU</code>算法删除最近没有使用的实例</li> <li>设置为第一个子组件对象的<code>keep-alive</code>为<code>true</code></li></ol> <ul><li><p>keep-alive 包含的组件生命周期可以有下列两个方法</p> <ul><li>activated</li> <li>deactivated</li> <li>可以有 include，exclude  用来排除不需要缓存的组件。</li></ul> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span> <span class="token attr-name">exclude</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>xxx,xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span></code></pre></div></li></ul> <h4 id="_10-computed-和-watch-有啥区别"><a href="#_10-computed-和-watch-有啥区别" class="header-anchor">#</a> 10. computed 和 watch 有啥区别</h4> <p>相同点：都监听/依赖一个数据，并进行处理。</p> <p>不同点：<code>computed</code>是对同步数据的处理，<code>watch</code>主要是观测某个数据的变化进而去执行一大段业务逻辑。</p> <p>能用 <code>computed</code>就不用<code>watch</code>。</p> <ul><li><p><code>computed</code>（计算属性）：</p> <ul><li>用来处理复杂的模板逻辑运算，类似过滤器，是对同步数据的处理。</li> <li><strong>计算属性是基于它们的响应式依赖进行缓存的</strong>。只在相关响应式依赖发生改变时它们才会重新求值。</li> <li>计算属性会缓存结果，避免重复计算。组件的 data 发生改变才进行计算。</li></ul></li> <li><p><code>watch</code>（侦听属性）：</p> <ul><li><p>用来观察和响应 Vue 实例上数据的变动，然后进行一些操作，执行一些方法（一般是异步操作）。</p></li> <li><p>使用 <code>watch</code> 选项允许我们执行异步操作 (访问一个 API)，限制我们执行该操作的频率，并在我们得到最终结果前，设置中间状态。这些都是计算属性无法做到的。</p></li> <li><p><code>watch</code>初始化的时候不会执行，需要加上<code>immediate:true</code>才可以。</p></li> <li><p><code>deep:true</code></p> <ul><li>深度遍历，因为 Vue 不能检测到对象属性直接的添加或删除。下面的 <code>obj.a</code>值的改变是检测不到的。</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>obj.a: {{obj.a}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>obj.a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    obj<span class="token operator">:</span> <span class="token punctuation">{</span>
    	a<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    obj<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'obj.a changed'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      immediate<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">// 给每个属性都加一层监听性能开销太大,改成下面，只有遇到 `obj.a`才进行监听。</span>
    watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'obj.a'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'obj.a changed'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      immediate<span class="token operator">:</span> <span class="token boolean">true</span>
      deep<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div></li></ul></li></ul> <h4 id="_11-依赖注入"><a href="#_11-依赖注入" class="header-anchor">#</a> 11. 依赖注入</h4> <p><strong>优点</strong></p> <blockquote><p>可以理解为大范围有效的 <code>props</code> ，它可以使用提供者的方法，而不需要知道提供者是谁。</p></blockquote> <p>子元素通过 <code>inject['方法名']</code> 的方式接收指定的父元素的方法。父元素通过 <code>provide</code> 给后代组件提供方法或数据。</p> <p><code>provide</code> 和 <code>inject</code> 是组件上的实例选项。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 祖先组件提供方法。</span>
<span class="token function-variable function">provide</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    getMap<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getMap
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 子孙组件注入使用</span>
inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'getMap'</span><span class="token punctuation">]</span>
</code></pre></div><ul><li>祖先组件不需要知道哪些后代组件使用它提供的属性</li> <li>后代组件不需要知道被注入的属性来自哪里</li></ul> <p><strong>缺点</strong></p> <p>耦合性高，重构困难。重要的是提供的数据是非响应式的。建议使用 <code>Vuex</code> 。</p> <h3 id="vuex-问题"><a href="#vuex-问题" class="header-anchor">#</a> Vuex 问题</h3> <p>什么需要放到 vuex 上，需要共享的数据。</p> <ul><li>token、名称、位置、头像、商品、收藏等。</li></ul> <h4 id="_1-获取veux上的state"><a href="#_1-获取veux上的state" class="header-anchor">#</a> 1. 获取veux上的state</h4> <p>由于 Vuex 的状态存储是响应式的，从 store 实例中读取状态最简单的方法就是在计算属性中返回某个状态：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">count</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>count
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>获取多个 辅助函数 mapState 返回的是一个对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//映射的计算属性的名称与 state 的子节点名称相同,都是address 可以简写成这样</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  # 相当于
 computed<span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>count
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
   # 相当于
 computed<span class="token operator">:</span> <span class="token function">mapState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">address</span><span class="token operator">:</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>address
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre></div><h4 id="_2-actions-和-mutations-有什么区别"><a href="#_2-actions-和-mutations-有什么区别" class="header-anchor">#</a> 2. actions 和 mutations 有什么区别</h4> <ul><li><p>mutation 做同步、action 做异步。</p></li> <li><p>事实上在 vuex 里面 actions 只是一个架构性的概念，并不是必须的，说到底只是一个函数，你在里面想干嘛都可以，只要最后触发 mutation 就行。异步竞态怎么处理那是用户自己的事情</p></li> <li><p>Action 提交的是 mutation，而不是直接变更状态。 Action 可以包含任意异步操作。个人觉得这个 action 的产生就是因为 mutation 不能进行异步操作，如果有异步操作那么就用 action 来提交mutation</p></li></ul> <h3 id="vue-router-问题"><a href="#vue-router-问题" class="header-anchor">#</a> vue-router 问题</h3> <blockquote><p>路由表：是一个映射表，决定了数据包的指向，内网 IP 和 mac 地址绑定。</p> <p>解析过程：</p> <ol><li>导航被触发。</li> <li>在失活的组件里调用离开守卫。</li> <li>调用全局的 <code>beforeEach</code> 守卫。</li> <li>在重用的组件里调用 <code>beforeRouteUpdate</code> 守卫 (2.2+)。</li> <li>在路由配置里调用 <code>beforeEnter</code>。</li> <li>解析异步路由组件。</li> <li>在被激活的组件里调用 <code>beforeRouteEnter</code>。</li> <li>调用全局的 <code>beforeResolve</code> 守卫 (2.5+)。</li> <li>导航被确认。</li> <li>调用全局的 <code>afterEach</code> 钩子。</li> <li>触发 DOM 更新。</li> <li>用创建好的实例调用 <code>beforeRouteEnter</code> 守卫中传给 <code>next</code> 的回调函数。</li></ol></blockquote> <h4 id="_1-使用"><a href="#_1-使用" class="header-anchor">#</a> 1.使用</h4> <ul><li><p>通过 Vue.use(Router) 安装插件</p></li> <li><p>通过 mode 配置 hash 和 history 两种模式</p></li> <li><p>可以在方法中获取 this.$router</p></li></ul> <h4 id="_1-1-router-link"><a href="#_1-1-router-link" class="header-anchor">#</a> 1.1 Router-link</h4> <div class="language-html extra-class"><pre class="language-html"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>--!</span> <span class="token attr-name">默认是</span> <span class="token attr-name">push</span> <span class="token attr-name">浏览器可以前进、回退</span> <span class="token attr-name">--</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">'</span>/path<span class="token punctuation">'</span></span> <span class="token attr-name">replace</span> <span class="token attr-name">active-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>active 可以在路由统一定义选中样式<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>   
</code></pre></div><h4 id="_1-2-route-vs-router"><a href="#_1-2-route-vs-router" class="header-anchor">#</a> 1.2 $route vs $router</h4> <ul><li><code>$route</code> 代表当前路由，可以配置 meta 等属性。例如可以在  <code>beforeEach</code> 里面实现获取每一个 meta 的 title 改变标签页的 title</li> <li><code>$router</code> 是路由方法，是 new Router 。</li></ul> <h4 id="_1-3-前端路由原理"><a href="#_1-3-前端路由原理" class="header-anchor">#</a> 1.3 前端路由原理</h4> <blockquote><p>本质是监听 url 的变化，根据匹配的规则动态显示网页。</p></blockquote> <ul><li><p><code>hash</code> 模式</p> <ul><li><p>通过 <code>hasChange</code> 事件监听 <code>/#/</code> 后面 <code>URL</code> 的变化跳转到对应的页面。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token operator">=</span><span class="token string">&quot;#search&quot;</span>
window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">matchAndUpdate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// todo 匹配 hash 做 dom 更新操作</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> matchAndUpdate<span class="token punctuation">)</span>

</code></pre></div></li> <li><p><code>/#/</code> 后 <code>URL</code> 的变化不会向服务端请求数据。</p></li> <li><p>手动刷新当前页面的时候不会触发 <code>hasChange</code> 事件。</p></li></ul></li> <li><p><code>history</code> 模式</p> <ul><li><p><code>html5</code> 新模式，比 <code>hash</code> 模式美观（没有 <code>/#/</code>），又提供了 <code>history</code> API。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>通过调用 <code>pushState</code> <code>go</code> 等方法实现跳转。</p></li> <li><p><code>URl</code> 改变的时候会向服务端请求，所以部署的时候需要进行重定向。</p> <div class="language-sh extra-class"><pre class="language-sh"><code> <span class="token comment"># nginx config</span>
 location @router <span class="token punctuation">{</span>
            rewrite ^.*$ /index.html <span class="token builtin class-name">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <h3 id="vue-3-0"><a href="#vue-3-0" class="header-anchor">#</a> Vue 3.0</h3> <blockquote><p>将 2.x 中与组件逻辑相关的选项以 API 函数的形式重新设计。</p> <p>2.x 设计基于选项，3.x 设计基于函数。目的是为了让新 API 抽取逻辑变简单。达到复用，或更为了更好的组织代码。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> computed<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
      &lt;span&gt;count is {{ count }}&lt;/span&gt;
      &lt;span&gt;plusOne is {{ plusOne }}&lt;/span&gt;
      &lt;button @click=&quot;increment&quot;&gt;count++&lt;/button&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// reactive state</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">// computed state</span>
    <span class="token keyword">const</span> plusOne <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// method</span>
    <span class="token keyword">const</span> <span class="token function-variable function">increment</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> count<span class="token punctuation">.</span>value<span class="token operator">++</span> <span class="token punctuation">}</span>
    <span class="token comment">// watch</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token punctuation">.</span>value <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">count * 2 is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// lifecycle</span>
      <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mounted</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// expose bindings on render context</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">,</span>
        plusOne<span class="token punctuation">,</span>
        increment
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

</code></pre></div><h4 id="_1-vue2-0-存在的问题"><a href="#_1-vue2-0-存在的问题" class="header-anchor">#</a> 1. Vue2.0 存在的问题</h4> <ul><li>逻辑复用与组合不清晰，前者模板数据来源不明，存在 Mixins 冲突。后二者需要额外的组件封装逻辑，导致无谓的性能开销。
<ul><li>Mixins</li> <li>高阶组件</li> <li><code>slot</code> / 插槽组件等</li> <li>一个请求需要多个选项 api 协助
<ul><li>要用到 <code>props</code>, <code>data()</code>, <code>mounted</code> 和 <code>watch</code>，等。会随着业务的加深变得不好维护。</li></ul></li></ul></li></ul> <h4 id="_2-使用-function-api-解决的问题"><a href="#_2-使用-function-api-解决的问题" class="header-anchor">#</a> 2. 使用 function API 解决的问题</h4> <ul><li>可以解决上述问题</li> <li>对 <code>TS</code> 支持友好
<ul><li><code>TS</code> 对函数的参数、返回值和泛型的支持已经非常完备</li></ul></li> <li>更小的打包尺寸
<ul><li>函数名和 <code>setup</code> 函数体内部的变量名都可以被压缩，但对象和 <code>class</code> 的属性/方法名却不可以。</li></ul></li> <li>一个 <code>setup()</code>函数可以解决上述需要多个选项 api 协助的事情。
<ul><li>因为我们可以把 <code>setup</code>函数内部的逻辑拆分成更小的函数，可以进行剥离，如果基于选项 API 是做不到的，更别提 Mixins 维护它只会让你更烦恼。</li></ul></li></ul> <h4 id="_3-组件状态"><a href="#_3-组件状态" class="header-anchor">#</a> 3. 组件状态</h4> <ul><li><p><code>setup()</code> (是一个组件选项)</p> <ul><li><p>在组件实例被创建时，初始化 <code>props</code> 后调用，第一个参数就是 <code>props</code>，内部的 <code>props</code> 会和外部保持一致。但是你不能在组件内部修改 <code>props</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>setup()</code> 与 2.x 的 <code>data()</code> 类似，可以返回一个对象提供给当前模板渲染。</p></li></ul></li> <li><p><code>setup()</code> 如何创建一个可以在内部管理的值。</p> <ul><li><p><code>ref()</code> ，它返回一个包装对象，这个对象只有 <code>value</code> 一个属性。包装对象的意义就在于我们在函数之间能够以引用的方式传递任意值类型的容器。下面返回了 <code>msg</code>，<code>appendName</code>。你可以在当前上下文中任意引用。在 Vue 3.x 中这个数据是响应式的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">appendName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 对value属性赋值进行修改</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>
      appendName
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// msg 在模板中会自动展开内部的值</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div @click=&quot;appendName&quot;&gt;{{ msg }}&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span> 
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p><code>computed()</code></p> <ul><li><p>包装计算属性返回的值</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> countPlusOne <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>countPlusOne<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 1</span>


<span class="token comment">// 请注意：你不能直接修改 countPlusOne.vlaue 因为计算属性的返回值是只读的</span>
<span class="token comment">// 只有当依赖变化的时候它才会被重新计算</span>
count<span class="token punctuation">.</span>value<span class="token operator">++</span> <span class="token comment">// 修改原始 ref 返回的包装对象，计算机属性会保持同步更新，</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>countPlusOne<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 2</span>
</code></pre></div></li></ul></li> <li><p>Wathcers</p> <ul><li><p><code>watch()</code> API 提供了基于观察状态的变化来执行副作用的能力。</p></li> <li><p><code>watch()</code> 接收的第一个参数被称作 “数据源”，它可以是下面三种，第二个参数是 callback</p> <ul><li>一个返回任意值的函数</li> <li>一个包装对象</li> <li>一个包含上述两种数据源的数组</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">watch</span><span class="token punctuation">(</span>
  <span class="token comment">// getter</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token comment">// callback</span>
  <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> oldValue</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'count + 1 is: '</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token comment">// -&gt; count + 1 is: 1</span>

count<span class="token punctuation">.</span>value<span class="token operator">++</span>
<span class="token comment">// -&gt; count + 1 is: 2</span>
</code></pre></div></li> <li><p>与 2.x 的不同</p> <ul><li><p>callback 在组件创建的时候就会执行一次，2.x 需要设置<code>immediate: true</code> 选项。</p></li> <li><p>3.x <code>watch</code> 在<code>DOM</code> 渲染完成后调用，可以监听参数的变化直接请求数据进行渲染。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> Number
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token comment">// 监听传入 id 的变化请求数据</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> props<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      data
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul></li></ul> <h4 id="_4-生命周期函数"><a href="#_4-生命周期函数" class="header-anchor">#</a> 4. 生命周期函数</h4> <blockquote><p>所有现有的生命周期钩子都会有对应的 <code>onXXX</code> 函数（只能在 <code>setup()</code> 中使用）：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> onMounted<span class="token punctuation">,</span> onUpdated<span class="token punctuation">,</span> onUnmounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mounted!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">onUpdated</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updated!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// destroyed 调整为 unmounted</span>
    <span class="token function">onUnmounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'unmounted!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-依赖注入"><a href="#_5-依赖注入" class="header-anchor">#</a> 5. 依赖注入</h4> <p>在 2.x 中依赖注入的数据是非响应式的，在 3.x 中如注入一个包装对象数据是响应式的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> provide<span class="token punctuation">,</span> inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> CountSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Ancestor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// providing a ref can make it reactive</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>CountSymbol<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> Descendent <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 传入包装对象，Ancestor 改变 count,Descenden 中的 count 会更新。</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>CountSymbol<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-升级策略"><a href="#_6-升级策略" class="header-anchor">#</a> 6. 升级策略</h4> <ul><li>完全兼容旧写法，只是多了一个 <code>setup</code> 选项。适合复杂度较高的组件使用。也可以不用。</li> <li>提供可选的编译项，可以去掉依赖 2.x 的代码，减小打包体积。</li></ul> <h4 id="_7-对比-react-hooks"><a href="#_7-对比-react-hooks" class="header-anchor">#</a> 7. 对比 React Hooks</h4> <p><strong>相同点：</strong></p> <ul><li>具有同等的基于函数抽取和复用逻辑的能力</li></ul> <p><strong>不同点：</strong></p> <ul><li>组件函数调用次数、调用顺序、是否能有条件的调用都不同。
<ul><li>React Hooks 在每次组件渲染的时候都会调用，通过隐式的将当前状态挂载在当前组件内部节点上，在下一次渲染的时候顺序取出。</li> <li>Vue 的 <code>setup</code> 只会在组件实例化的时候调用一次，通过引用在 <code>setup</code> 函数内的闭包达到更新的目的。</li> <li><code>setup</code>  不受调用顺序的影响，且可以有条件的调用，例如 <code>if...else</code> 等。</li></ul></li> <li>不需要使用 <code>useCallback</code> 缓存给子组件的更新，防止过度回调。</li> <li>不需要像给 <code>useEffect、useMemo、useCallback</code>  传错依赖而导致更新错误，Vue 是响应式的，依赖是全局追踪的，不需要手动维护。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/awesome/assets/js/app.bdba70c4.js" defer></script><script src="/awesome/assets/js/2.2e371d65.js" defer></script><script src="/awesome/assets/js/11.06d3aa78.js" defer></script>
  </body>
</html>
